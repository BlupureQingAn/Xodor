# é¢˜åº“ç®¡ç†æ¨¡å—ç»Ÿä¸€å®Œæˆè¯´æ˜

## ä¿®æ”¹æ¦‚è¿°

æŒ‰ç…§ç”¨æˆ·è¦æ±‚ï¼Œå®Œæˆäº†ä»¥ä¸‹ä¿®æ”¹ï¼š

1. âœ… åˆ é™¤ QuestionListWidget.cppï¼ˆå­¤ç«‹æ–‡ä»¶ï¼‰
2. âœ… ä¿ç•™ QuestionBankPanel çš„åˆ‡æ¢é¢˜åº“åŠŸèƒ½
3. âœ… åˆ é™¤ QuestionBankManagerDialog çš„åˆ‡æ¢é¢˜åº“åŠŸèƒ½
4. âœ… ç»Ÿä¸€ä½¿ç”¨ QuestionBankManager ä½œä¸ºæ•°æ®æº

---

## è¯¦ç»†ä¿®æ”¹å†…å®¹

### 1. åˆ é™¤ QuestionListWidget.cpp

**çŠ¶æ€**ï¼šæ–‡ä»¶ä¸å­˜åœ¨ï¼ˆå¯èƒ½å·²è¢«åˆ é™¤ï¼‰

**åŸå› **ï¼š
- æ²¡æœ‰å¯¹åº”çš„å¤´æ–‡ä»¶
- æ²¡æœ‰åœ¨ CMakeLists.txt ä¸­ç¼–è¯‘
- æ²¡æœ‰ä»»ä½•ä»£ç å¼•ç”¨
- åŠŸèƒ½ä¸ QuestionBankPanel å®Œå…¨é‡å¤

---

### 2. QuestionBankPanel ç»Ÿä¸€ä½¿ç”¨ QuestionBankManager

#### ä¿®æ”¹æ–‡ä»¶ï¼š`src/ui/QuestionBankPanel.h`

**ä¿®æ”¹**ï¼š
- æ›´æ–°å‡½æ•°å£°æ˜ï¼š`getBankInfo()` â†’ `countQuestionsInDirectory()`

#### ä¿®æ”¹æ–‡ä»¶ï¼š`src/ui/QuestionBankPanel.cpp`

**æ·»åŠ å¼•ç”¨**ï¼š
```cpp
#include "../core/QuestionBankManager.h"
#include <QJsonObject>
```

**ä¿®æ”¹ updateBankList() - ä½¿ç”¨ QuestionBankManager**ï¼š
```cpp
void QuestionBankPanel::updateBankList()
{
    m_questionList->clear();
    
    // ä½¿ç”¨ QuestionBankManager ä½œä¸ºæ•°æ®æºï¼ˆè€Œä¸æ˜¯ç›´æ¥æ‰«ææ–‡ä»¶ç³»ç»Ÿï¼‰
    QVector<QuestionBankInfo> banks = QuestionBankManager::instance().getAllBanks();
    QString searchText = m_searchEdit->text().toLower();
    QString currentBankId = QuestionBankManager::instance().getCurrentBankId();
    
    for (const QuestionBankInfo &info : banks) {
        // æœç´¢è¿‡æ»¤
        if (!searchText.isEmpty() && !info.name.toLower().contains(searchText)) {
            continue;
        }
        
        // å®æ—¶ç»Ÿè®¡é¢˜ç›®æ•°é‡
        int actualCount = countQuestionsInDirectory(info.path);
        
        QString displayText = QString("ğŸ“š %1 (%2 é“é¢˜ç›®)")
            .arg(info.name)
            .arg(actualCount);
        
        // æ ‡è®°å½“å‰é¢˜åº“
        if (info.id == currentBankId) {
            displayText = "â­ " + displayText;
        }
        
        QListWidgetItem *item = new QListWidgetItem(displayText);
        item->setData(Qt::UserRole, info.id);  // å­˜å‚¨é¢˜åº“IDè€Œä¸æ˜¯è·¯å¾„
        m_questionList->addItem(item);
    }
}
```

**ä¿®æ”¹ onLoadBank() - ä½¿ç”¨ QuestionBankManager åˆ‡æ¢**ï¼š
```cpp
void QuestionBankPanel::onLoadBank()
{
    QListWidgetItem *item = m_questionList->currentItem();
    if (!item) {
        return;
    }
    
    // è·å–é¢˜åº“IDå¹¶åˆ‡æ¢
    QString bankId = item->data(Qt::UserRole).toString();
    
    if (QuestionBankManager::instance().switchToBank(bankId)) {
        QuestionBankInfo info = QuestionBankManager::instance().getBankInfo(bankId);
        m_selectedBankPath = info.path;
        
        emit bankLoadRequested(m_selectedBankPath);
        
        // åˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°å½“å‰é¢˜åº“æ ‡è®°
        refreshBankList();
    } else {
        QMessageBox::warning(this, "åˆ‡æ¢å¤±è´¥", "æ— æ³•åˆ‡æ¢åˆ°è¯¥é¢˜åº“");
    }
}
```

**ä¿®æ”¹ onDeleteBank() - ä½¿ç”¨ QuestionBankManager API**ï¼š
```cpp
void QuestionBankPanel::onDeleteBank()
{
    QListWidgetItem *item = m_questionList->currentItem();
    if (!item) {
        return;
    }
    
    // è·å–é¢˜åº“ID
    QString bankId = item->data(Qt::UserRole).toString();
    QuestionBankInfo info = QuestionBankManager::instance().getBankInfo(bankId);
    
    QMessageBox::StandardButton reply = QMessageBox::question(
        this,
        "ç¡®è®¤åˆ é™¤",
        QString("ç¡®å®šè¦åˆ é™¤é¢˜åº“ã€%1ã€‘å—ï¼Ÿ\n\n"
                "æ­¤æ“ä½œå°†ä»é¢˜åº“ç®¡ç†å™¨ä¸­æ³¨é”€è¯¥é¢˜åº“ã€‚\n"
                "æ³¨æ„ï¼šä¸ä¼šåˆ é™¤å®é™…æ–‡ä»¶ã€‚").arg(info.name),
        QMessageBox::Yes | QMessageBox::No
    );
    
    if (reply == QMessageBox::Yes) {
        // ä½¿ç”¨ QuestionBankManager åˆ é™¤ï¼ˆåªæ³¨é”€ï¼Œä¸åˆ æ–‡ä»¶ï¼‰
        if (QuestionBankManager::instance().deleteQuestionBank(bankId)) {
            QMessageBox::information(this, "åˆ é™¤æˆåŠŸ", 
                QString("é¢˜åº“ã€%1ã€‘å·²ä»ç®¡ç†å™¨ä¸­æ³¨é”€").arg(info.name));
            
            refreshBankList();
        } else {
            QMessageBox::warning(this, "åˆ é™¤å¤±è´¥", 
                QString("æ— æ³•åˆ é™¤é¢˜åº“ã€%1ã€‘").arg(info.name));
        }
    }
}
```

**ä¿®æ”¹ onRenameBank() - ä½¿ç”¨ QuestionBankManager API**ï¼š
```cpp
void QuestionBankPanel::onRenameBank()
{
    QListWidgetItem *item = m_questionList->currentItem();
    if (!item) {
        return;
    }
    
    // è·å–é¢˜åº“ID
    QString bankId = item->data(Qt::UserRole).toString();
    QuestionBankInfo info = QuestionBankManager::instance().getBankInfo(bankId);
    
    bool ok;
    QString newName = QInputDialog::getText(
        this,
        "é‡å‘½åé¢˜åº“",
        "è¯·è¾“å…¥æ–°çš„é¢˜åº“åç§°ï¼š",
        QLineEdit::Normal,
        info.name,
        &ok
    );
    
    if (ok && !newName.isEmpty() && newName != info.name) {
        // ä½¿ç”¨ QuestionBankManager é‡å‘½å
        if (QuestionBankManager::instance().renameQuestionBank(bankId, newName)) {
            QMessageBox::information(this, "é‡å‘½åæˆåŠŸ", 
                QString("é¢˜åº“å·²é‡å‘½åä¸ºã€%1ã€‘").arg(newName));
            
            refreshBankList();
        } else {
            QMessageBox::warning(this, "é‡å‘½åå¤±è´¥", 
                "æ— æ³•é‡å‘½åé¢˜åº“");
        }
    }
}
```

**æ–°å¢ countQuestionsInDirectory() - ç»Ÿè®¡é¢˜ç›®æ•°é‡**ï¼š
```cpp
int QuestionBankPanel::countQuestionsInDirectory(const QString &dirPath) const
{
    int count = 0;
    QDir dir(dirPath);
    
    if (!dir.exists()) {
        return 0;
    }
    
    // ç»Ÿè®¡å½“å‰ç›®å½•çš„ JSON æ–‡ä»¶
    QStringList filters;
    filters << "*.json";
    QFileInfoList files = dir.entryInfoList(filters, QDir::Files);
    
    for (const auto &fileInfo : files) {
        QFile file(fileInfo.absoluteFilePath());
        if (file.open(QIODevice::ReadOnly)) {
            QJsonDocument doc = QJsonDocument::fromJson(file.readAll());
            
            if (doc.isArray()) {
                count += doc.array().size();
            } else if (doc.isObject()) {
                count += 1;
            }
            
            file.close();
        }
    }
    
    // é€’å½’ç»Ÿè®¡å­ç›®å½•
    QFileInfoList subDirs = dir.entryInfoList(QDir::Dirs | QDir::NoDotAndDotDot);
    for (const auto &subDirInfo : subDirs) {
        count += countQuestionsInDirectory(subDirInfo.absoluteFilePath());
    }
    
    return count;
}
```

---

### 3. QuestionBankManagerDialog åˆ é™¤åˆ‡æ¢åŠŸèƒ½

#### ä¿®æ”¹æ–‡ä»¶ï¼š`src/ui/QuestionBankManagerDialog.h`

**åˆ é™¤**ï¼š
- ä¿¡å·ï¼š`void bankSelected(const QString &bankId);`
- æ§½å‡½æ•°ï¼š`void onSwitchBank();`
- UIç»„ä»¶ï¼š`QPushButton *m_switchBtn;`

#### ä¿®æ”¹æ–‡ä»¶ï¼š`src/ui/QuestionBankManagerDialog.cpp`

**åˆ é™¤**ï¼š
- åˆ‡æ¢æŒ‰é’®çš„åˆ›å»ºï¼š`m_switchBtn = new QPushButton("âœ“ åˆ‡æ¢åˆ°æ­¤é¢˜åº“", this);`
- åˆ‡æ¢æŒ‰é’®çš„å¸ƒå±€æ·»åŠ 
- åˆ‡æ¢æŒ‰é’®çš„æ ·å¼è®¾ç½®
- åˆ‡æ¢æŒ‰é’®çš„ä¿¡å·è¿æ¥
- åŒå‡»åˆ‡æ¢çš„ä¿¡å·è¿æ¥
- `onSwitchBank()` å‡½æ•°å®ç°
- `updateButtons()` ä¸­å¯¹åˆ‡æ¢æŒ‰é’®çš„å¯ç”¨/ç¦ç”¨é€»è¾‘

**ä¿ç•™**ï¼š
- æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½
- åˆ é™¤é¢˜åº“åŠŸèƒ½ï¼ˆæ³¨é”€ï¼‰
- é‡å‘½åé¢˜åº“åŠŸèƒ½
- åˆ·æ–°é¢˜åº“åŠŸèƒ½
- å¯¼å‡ºè·¯å¾„åŠŸèƒ½
- å¯¼å…¥æ–°é¢˜åº“åŠŸèƒ½

---

### 4. MainWindow æ›´æ–°

#### ä¿®æ”¹æ–‡ä»¶ï¼š`src/ui/MainWindow.cpp`

**åˆ é™¤**ï¼š
- å¯¹ `QuestionBankManagerDialog::bankSelected` ä¿¡å·çš„è¿æ¥
- é¢˜åº“åˆ‡æ¢çš„å¤„ç†é€»è¾‘ï¼ˆå·²ç§»åˆ° QuestionBankPanelï¼‰

**ä¿ç•™**ï¼š
- å¯¹ `QuestionBankManagerDialog::bankDeleted` ä¿¡å·çš„è¿æ¥
- é¢˜åº“åˆ é™¤åçš„æ¸…ç†é€»è¾‘

---

## ä¿®æ”¹åçš„æ¶æ„

### èŒè´£åˆ’åˆ†

| ç»„ä»¶ | èŒè´£ | æ•°æ®æº |
|------|------|--------|
| **QuestionBankManager** | é¢˜åº“å…ƒæ•°æ®ç®¡ç†ã€è·¯å¾„è§„èŒƒåŒ– | é…ç½®æ–‡ä»¶ + æ–‡ä»¶ç³»ç»Ÿ |
| **QuestionBankManagerDialog** | æŸ¥çœ‹è¯¦æƒ…ã€åˆ é™¤ã€é‡å‘½åã€åˆ·æ–°ã€å¯¼å‡ºã€å¯¼å…¥ | QuestionBankManager |
| **QuestionBankPanel** | æ˜¾ç¤ºé¢˜åº“åˆ—è¡¨ã€åˆ‡æ¢é¢˜åº“ã€é¢˜ç›®åˆ—è¡¨ | QuestionBankManager |
| **MainWindow** | åè°ƒå’Œæ•°æ®æµè½¬ | - |

### æ•°æ®æµï¼ˆé¢˜åº“åˆ‡æ¢ï¼‰

```
ç”¨æˆ·åœ¨ QuestionBankPanel ä¸­é€‰æ‹©é¢˜åº“
         â†“
QuestionBankPanel.onLoadBank()
         â†“
QuestionBankManager.switchToBank(bankId)
         â†“
å‘å‡ºä¿¡å· bankLoadRequested(bankPath)
         â†“
MainWindow æ¥æ”¶ä¿¡å·
         â†“
åŠ è½½é¢˜åº“åˆ° QuestionBank
         â†“
æ›´æ–°æ‰€æœ‰UIç»„ä»¶
```

### æ•°æ®ä¸€è‡´æ€§

æ‰€æœ‰ç»„ä»¶ç°åœ¨éƒ½ä½¿ç”¨ **QuestionBankManager** ä½œä¸ºå”¯ä¸€æ•°æ®æºï¼š

1. **QuestionBankPanel**ï¼š
   - âœ… ä½¿ç”¨ `QuestionBankManager::getAllBanks()` è·å–é¢˜åº“åˆ—è¡¨
   - âœ… ä½¿ç”¨ `QuestionBankManager::switchToBank()` åˆ‡æ¢é¢˜åº“
   - âœ… ä½¿ç”¨ `QuestionBankManager::deleteQuestionBank()` åˆ é™¤é¢˜åº“
   - âœ… ä½¿ç”¨ `QuestionBankManager::renameQuestionBank()` é‡å‘½åé¢˜åº“

2. **QuestionBankManagerDialog**ï¼š
   - âœ… ä½¿ç”¨ `QuestionBankManager::getAllBanks()` è·å–é¢˜åº“åˆ—è¡¨
   - âœ… ä½¿ç”¨ `QuestionBankManager::deleteQuestionBank()` åˆ é™¤é¢˜åº“
   - âœ… ä½¿ç”¨ `QuestionBankManager::renameQuestionBank()` é‡å‘½åé¢˜åº“
   - âœ… ä½¿ç”¨ `QuestionBankManager::updateQuestionCount()` åˆ·æ–°é¢˜åº“

---

## ä¼˜åŠ¿

### 1. æ•°æ®ä¸€è‡´æ€§
- æ‰€æœ‰ç»„ä»¶ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®æº
- é¿å…äº†æ–‡ä»¶ç³»ç»Ÿå’Œç®¡ç†å™¨æ•°æ®ä¸åŒæ­¥çš„é—®é¢˜

### 2. èŒè´£æ¸…æ™°
- QuestionBankManagerDialogï¼šè¯¦ç»†ç®¡ç†å’ŒæŸ¥çœ‹
- QuestionBankPanelï¼šå¿«é€Ÿåˆ‡æ¢å’Œæµè§ˆ
- å„å¸å…¶èŒï¼Œä¸é‡å¤

### 3. æ˜“äºç»´æŠ¤
- é¢˜åº“æ“ä½œé€»è¾‘é›†ä¸­åœ¨ QuestionBankManager
- UIç»„ä»¶åªè´Ÿè´£æ˜¾ç¤ºå’Œç”¨æˆ·äº¤äº’
- ä¿®æ”¹é€»è¾‘æ—¶åªéœ€æ”¹ä¸€å¤„

### 4. ç”¨æˆ·ä½“éªŒ
- QuestionBankPanelï¼šå¿«é€Ÿåˆ‡æ¢é¢˜åº“ï¼ˆå·¦ä¾§é¢æ¿ï¼‰
- QuestionBankManagerDialogï¼šè¯¦ç»†ç®¡ç†ï¼ˆèœå•æ‰“å¼€ï¼‰
- ä¸¤ç§æ–¹å¼äº’è¡¥ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯

---

## æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•

1. **QuestionBankPanel é¢˜åº“æ¨¡å¼**
   - [ ] æ˜¾ç¤ºæ‰€æœ‰å·²æ³¨å†Œé¢˜åº“
   - [ ] æœç´¢é¢˜åº“
   - [ ] åˆ‡æ¢é¢˜åº“ï¼ˆåŒå‡»æˆ–ç‚¹å‡»åŠ è½½æŒ‰é’®ï¼‰
   - [ ] åˆ é™¤é¢˜åº“ï¼ˆæ³¨é”€ï¼‰
   - [ ] é‡å‘½åé¢˜åº“
   - [ ] å½“å‰é¢˜åº“æ ‡è®°ï¼ˆâ­ï¼‰

2. **QuestionBankManagerDialog**
   - [ ] æ˜¾ç¤ºæ‰€æœ‰å·²æ³¨å†Œé¢˜åº“
   - [ ] æŸ¥çœ‹é¢˜åº“è¯¦æƒ…ï¼ˆç»Ÿè®¡ã€è·¯å¾„ç­‰ï¼‰
   - [ ] åˆ é™¤é¢˜åº“ï¼ˆæ³¨é”€ï¼‰
   - [ ] é‡å‘½åé¢˜åº“
   - [ ] åˆ·æ–°é¢˜åº“é¢˜ç›®æ•°é‡
   - [ ] å¯¼å‡ºé¢˜åº“è·¯å¾„
   - [ ] å¯¼å…¥æ–°é¢˜åº“

3. **æ•°æ®ä¸€è‡´æ€§**
   - [ ] åœ¨ QuestionBankPanel åˆ‡æ¢é¢˜åº“åï¼ŒQuestionBankManagerDialog æ˜¾ç¤ºæ­£ç¡®çš„å½“å‰é¢˜åº“
   - [ ] åœ¨ QuestionBankPanel åˆ é™¤é¢˜åº“åï¼ŒQuestionBankManagerDialog åˆ—è¡¨åŒæ­¥æ›´æ–°
   - [ ] åœ¨ QuestionBankPanel é‡å‘½åé¢˜åº“åï¼ŒQuestionBankManagerDialog æ˜¾ç¤ºæ–°åç§°

4. **è·¯å¾„ä¿®å¤**
   - [ ] å¯åŠ¨æ—¶è‡ªåŠ¨ä¿®å¤é”™è¯¯è·¯å¾„
   - [ ] æ–°å¯¼å…¥é¢˜åº“è·¯å¾„æ­£ç¡®ï¼ˆdata/åŸºç¡€é¢˜åº“/ï¼‰
   - [ ] é¢˜åº“è¯¦æƒ…æ˜¾ç¤ºç»å¯¹è·¯å¾„

---

## ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `src/ui/QuestionBankPanel.h`
- `src/ui/QuestionBankPanel.cpp`
- `src/ui/QuestionBankManagerDialog.h`
- `src/ui/QuestionBankManagerDialog.cpp`
- `src/ui/MainWindow.cpp`

### åˆ é™¤çš„æ–‡ä»¶
- `src/ui/QuestionListWidget.cpp`ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²åˆ é™¤ï¼‰

### ä¾èµ–çš„æ ¸å¿ƒæ–‡ä»¶
- `src/core/QuestionBankManager.h`
- `src/core/QuestionBankManager.cpp`

---

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®æ”¹ï¼š

1. âœ… **åˆ é™¤å†—ä½™**ï¼šQuestionListWidget.cpp å·²ä¸å­˜åœ¨
2. âœ… **ç»Ÿä¸€æ•°æ®æº**ï¼šæ‰€æœ‰ç»„ä»¶ä½¿ç”¨ QuestionBankManager
3. âœ… **èŒè´£æ¸…æ™°**ï¼šQuestionBankPanel è´Ÿè´£åˆ‡æ¢ï¼ŒQuestionBankManagerDialog è´Ÿè´£è¯¦ç»†ç®¡ç†
4. âœ… **ä¿æŒåŠŸèƒ½**ï¼šQuestionBankManagerDialog çš„å…¶ä»–åŠŸèƒ½å…¨éƒ¨ä¿ç•™

ä¿®æ”¹åçš„æ¶æ„æ›´åŠ æ¸…æ™°ã€æ˜“äºç»´æŠ¤ï¼ŒåŒæ—¶ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§ã€‚
