# 历史记录题目标题显示修复

## 问题描述
历史记录窗口中题目标题没有正确显示，只显示题目ID。

## 根本原因
虽然在 `onQuestionFileSelected()` 中调用了 `setQuestionTitle()` 保存标题，但是：
1. 只有在从题库面板选择题目时才会保存标题
2. 在运行测试或AI判题时没有再次确保标题已保存
3. 如果用户直接运行测试而没有重新选择题目，标题可能不会被保存

## 解决方案

### 1. 自动从题库文件加载缺失的标题
**文件**: `src/ui/HistoryWidget.cpp`, `src/ui/HistoryWidget.h`

在 `loadHistory()` 中，如果进度记录中没有标题，自动从题库文件中查找并加载：

```cpp
// 题目标题（从进度记录中获取，如果为空则尝试从文件加载）
QString title = record.questionTitle;
if (title.isEmpty()) {
    // 尝试从题库文件中读取标题
    title = loadQuestionTitleFromFile(questionId);
    
    if (!title.isEmpty()) {
        // 找到标题后，更新进度记录
        pm.setQuestionTitle(questionId, title);
        qDebug() << "[HistoryWidget] Loaded and saved title for question" << questionId << ":" << title;
    } else {
        // 如果还是找不到，使用ID
        title = questionId;
        qDebug() << "[HistoryWidget] WARNING: No title found for question" << questionId;
    }
}
```

新增 `loadQuestionTitleFromFile()` 方法：
- 递归搜索当前题库中的所有.json文件
- 查找匹配的题目ID
- 返回题目标题
- 找到后自动更新进度记录，下次就不需要再搜索

### 2. 在运行测试时保存标题
**文件**: `src/ui/MainWindow.cpp`

在 `onRunTests()` 的结果处理部分，记录尝试之前先保存标题：

```cpp
// 更新刷题进度
if (m_currentQuestionIndex >= 0 && m_currentQuestionIndex < m_questionBank->count()) {
    Question currentQuestion = m_questionBank->allQuestions()[m_currentQuestionIndex];
    QString code = m_codeEditor->code();
    bool allPassed = (passed == total && total > 0);
    
    // 确保题目标题已保存（用于历史记录显示）
    ProgressManager::instance().setQuestionTitle(currentQuestion.id(), currentQuestion.title());
    
    ProgressManager::instance().recordAttempt(currentQuestion.id(), allPassed, code);
    // ...
}
```

### 2. 在AI判题时保存标题
**文件**: `src/ui/MainWindow.cpp`

在 `onAIJudgeCompleted()` 中，记录AI判定结果之前先保存标题：

```cpp
// 更新进度管理器
ProgressManager &progressMgr = ProgressManager::instance();

// 确保题目标题已保存（用于历史记录显示）
progressMgr.setQuestionTitle(questionId, currentQuestion.title());

// 记录AI判定结果
progressMgr.recordAIJudge(questionId, passed, comment);
```

### 3. 增强调试输出
**文件**: `src/core/ProgressManager.cpp`

在 `setQuestionTitle()` 中添加调试输出：

```cpp
void ProgressManager::setQuestionTitle(const QString &questionId, const QString &title)
{
    QuestionProgressRecord record = getProgress(questionId);
    record.questionTitle = title;
    m_progressMap[questionId] = record;
    
    qDebug() << "[ProgressManager] Set question title:" << questionId << "->" << title;
    qDebug() << "[ProgressManager] Progress map size:" << m_progressMap.size();
    
    save();
    
    emit progressUpdated(questionId);
}
```

**文件**: `src/ui/HistoryWidget.cpp`

在 `loadHistory()` 中添加调试输出：

```cpp
for (const QString &questionId : questionIds) {
    QuestionProgressRecord record = pm.getProgress(questionId);
    
    qDebug() << "[HistoryWidget] Question:" << questionId 
             << "Title:" << record.questionTitle
             << "Attempts:" << record.attemptCount;
    
    // ...
    
    // 题目标题（从进度记录中获取）
    QString title = record.questionTitle;
    if (title.isEmpty()) {
        title = questionId;  // 如果没有标题，显示ID
        qDebug() << "[HistoryWidget] WARNING: No title for question" << questionId;
    }
    m_historyTable->setItem(row, 1, new QTableWidgetItem(title));
}
```

## 修改的文件
1. `src/ui/HistoryWidget.h` - 添加 `loadQuestionTitleFromFile()` 方法声明
2. `src/ui/HistoryWidget.cpp` - 实现自动加载缺失标题的逻辑
3. `src/ui/MainWindow.cpp` - 在运行测试和AI判题时保存标题
4. `src/core/ProgressManager.cpp` - 增强调试输出

## 测试步骤
1. 编译并运行程序
2. 从题库面板选择一道题目
3. 运行测试或AI判题
4. 打开"历史 -> 查看做题记录"
5. 验证题目标题是否正确显示
6. 查看控制台输出，确认标题保存流程

## 预期结果
- 历史记录窗口中应该显示完整的题目标题
- **即使是旧的进度记录（没有标题字段），也会自动从题库文件中加载标题**
- 加载后的标题会自动保存到进度记录中，下次无需再次搜索
- 控制台应该输出标题加载和保存的调试信息

## 技术细节

### 数据流程
1. 用户选择题目 → `onQuestionFileSelected()` → `setQuestionTitle()`
2. 用户运行测试 → `onRunTests()` → `setQuestionTitle()` → `recordAttempt()`
3. 用户AI判题 → `onAIJudgeCompleted()` → `setQuestionTitle()` → `recordAIJudge()`
4. 查看历史 → `loadHistory()` → 从 `QuestionProgressRecord.questionTitle` 读取

### 为什么在多处保存标题
- **防御性编程**：确保无论用户通过什么路径操作，标题都会被保存
- **向后兼容**：旧的进度记录可能没有标题，通过自动加载机制补充
- **数据一致性**：每次记录进度时都确保标题是最新的
- **智能加载**：历史记录窗口会自动从题库文件中查找缺失的标题，无需用户重新做题

## 编译状态
✅ 编译成功，无错误
