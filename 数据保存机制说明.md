# 数据保存机制说明

## 概述
你在Qt Creator中运行程序时，所有的更改都会自动保存到`build/data`目录中。

## 数据保存位置

### 1. 题库数据（只读）
**位置**: `build/data/基础题库/CCF/`
**结构**: 分层存储，每道题一个JSON文件
```
build/data/基础题库/
└── CCF/
    ├── 31/
    │   ├── 坐标变换（其一）.json
    │   ├── 坐标变换（其二）.json
    │   └── ...
    ├── 32/
    ├── 33/
    └── ...
```
**说明**: 这是题库的原始数据，包含题目描述、测试用例等，**不会被修改**

### 2. 用户代码（自动保存）
**位置**: `build/data/user_answers/`
**文件命名**: `{题目ID}.json`
**保存时机**: 
- 代码编辑后200ms自动保存（防抖）
- 切换题目时立即保存
- 运行测试时立即保存

**示例文件**:
```json
{
    "questionId": "31_16733555202665192015",
    "code": "#include <iostream>\nusing namespace std;\n...",
    "lastModified": "2024-12-03T10:30:45"
}
```

**已验证**: 你的代码已经在保存了，例如：
- `31_10183846386172931333.json`
- `31_13873667192833354962.json`
- `31_16733555202665192015.json`
- 等等...

### 3. 代码版本历史（可选）
**位置**: `build/data/code_versions/`
**保存时机**: 测试通过时自动保存版本
**说明**: 记录每次测试通过的代码版本，方便回溯

### 4. 会话数据
**位置**: `C:\Users\{用户名}\AppData\Roaming\CodePracticeSystem\`
**文件**:
- `session.json` - 记录当前题库路径和题目索引
- `question_banks.json` - 题库管理配置（如果使用题库管理器）

## 数据保存机制详解

### 代码自动保存流程
1. **编辑代码** → 触发`onTextChanged()`
2. **200ms防抖** → 避免频繁保存
3. **保存到文件** → `data/user_answers/{题目ID}.json`
4. **发出信号** → `saved(questionId, content)`

### 关键代码
```cpp
// AutoSaver::performSave()
QString filePath = QString("data/user_answers/%1.json").arg(m_questionId);
QFile file(filePath);
if (file.open(QIODevice::WriteOnly)) {
    file.write(QJsonDocument(json).toJson());
    file.close();
}
```

### 相对路径说明
- 所有路径都是**相对路径**
- Qt Creator运行时，工作目录是`build`
- 所以`data/user_answers`实际是`build/data/user_answers`

## 题库数据的增删改查

### ❌ 当前不支持的操作
1. **修改题目内容** - 题库JSON文件是只读的，程序不会修改
2. **删除题目** - 只能从内存中移除，不会删除文件
3. **添加题目** - 需要通过AI导入功能

### ✅ 当前支持的操作
1. **加载题库** - 从`data/基础题库`自动加载
2. **保存代码** - 自动保存到`data/user_answers`
3. **保存版本** - 测试通过时保存到`data/code_versions`
4. **保存会话** - 记录当前进度到AppData

## 数据持久化保证

### 代码保存 ✅
- **自动保存**: 编辑后200ms自动保存
- **强制保存**: 切换题目、运行测试时立即保存
- **位置**: `build/data/user_answers/`
- **持久化**: ✅ 重启程序后代码不会丢失

### 题库数据 ✅
- **位置**: `build/data/基础题库/CCF/`
- **持久化**: ✅ 题库数据永久保存
- **加载**: ✅ 程序启动时自动加载

### 会话恢复 ✅
- **位置**: `AppData/Roaming/CodePracticeSystem/session.json`
- **内容**: 当前题库路径、题目索引
- **持久化**: ✅ 重启后恢复到上次的题目

## 如何验证数据已保存

### 1. 检查用户代码
```powershell
# 查看已保存的代码文件
Get-ChildItem build\data\user_answers -Filter "*.json"

# 查看某个题目的代码
Get-Content build\data\user_answers\31_16733555202665192015.json
```

### 2. 检查题库数据
```powershell
# 查看题库中的题目
Get-ChildItem build\data\基础题库\CCF -Recurse -Filter "*.json"

# 统计题目数量
(Get-ChildItem build\data\基础题库\CCF -Recurse -Filter "*.json").Count
```

### 3. 检查会话数据
```powershell
# 查看会话配置
Get-Content $env:APPDATA\CodePracticeSystem\session.json
```

## 数据安全建议

### 1. 定期备份
```powershell
# 备份整个data目录
Copy-Item -Recurse build\data backup\data_$(Get-Date -Format 'yyyyMMdd')
```

### 2. Git版本控制
```bash
# 将data目录加入版本控制（可选）
git add build/data/user_answers
git commit -m "保存用户代码"
```

### 3. 导出代码
- 可以手动复制`build/data/user_answers`目录
- 每个JSON文件包含完整的代码和时间戳

## 常见问题

### Q1: 代码会丢失吗？
**A**: 不会。代码自动保存到`build/data/user_answers`，重启程序后会自动加载。

### Q2: 题库数据会被修改吗？
**A**: 不会。题库数据是只读的，程序只读取不修改。

### Q3: 如何恢复之前的代码？
**A**: 
1. 查看`build/data/user_answers/{题目ID}.json`
2. 如果有版本历史，查看`build/data/code_versions/`

### Q4: 如何添加新题目？
**A**: 使用AI导入功能，从文件或文件夹导入题目。

### Q5: 数据在哪里？
**A**: 
- **开发环境**: `build/data/`（Qt Creator运行时）
- **发布版本**: `exe所在目录/data/`（打包后）

## 总结

✅ **代码保存**: 自动保存，200ms防抖，重启不丢失
✅ **题库数据**: 永久保存在`build/data/基础题库`
✅ **会话恢复**: 自动记录进度，重启后恢复
✅ **版本历史**: 测试通过时自动保存版本
✅ **数据安全**: 所有数据都在本地，不会丢失

你可以放心在Qt Creator中使用，所有更改都会自动保存！
