# AI智能导入完整工作流程

## 📋 功能概述

AI智能导入系统现在实现了完整的题库导入、解析、存储和规则生成流程，确保：
1. ✅ 原始题库安全备份（只读）
2. ✅ AI智能解析题目格式
3. ✅ 自动生成测试数据
4. ✅ 保存解析规则到config
5. ✅ 生成标准化基础题库
6. ✅ 自动生成出题模式规律

## 🔄 完整工作流程

### 第一步：原始题库备份 📁

**目标**: 将用户选择的题库文件完整拷贝到只读目录

```
源路径: 用户选择的文件夹
↓
目标路径: data/原始题库/{题库名称}/
```

**操作**:
- 拷贝所有 `.md`、`.markdown`、`.txt` 文件
- 设置文件为只读权限
- 禁止用户修改，确保原始数据安全

**代码位置**: `SmartQuestionImporter::copyQuestionBank()`

### 第二步：扫描和分析文件 📂

**目标**: 扫描原始题库，智能拆分大文件

```
原始题库文件
↓
分析文件大小和结构
↓
智能拆分为多个块（如果文件过大）
```

**拆分规则**:
- 单个块最大 8000 字符
- 按题目边界拆分（识别标题、题号等）
- 保持题目完整性

**代码位置**: `SmartQuestionImporter::scanAndAnalyzeFiles()`

### 第三步：AI智能解析 🤖

**目标**: 使用AI解析题目内容，提取结构化信息

```
文件块
↓
构建AI Prompt
↓
发送给Ollama/云端API
↓
接收JSON格式响应
```

**AI提取内容**:
- 题目标题
- 难度等级（简单/中等/困难）
- 完整描述
- 知识点标签
- 测试用例（至少5组）
  - 基本功能测试（2-3个）
  - 边界条件测试
  - 特殊情况测试

**代码位置**: `SmartQuestionImporter::parseChunkWithAI()`

### 第四步：保存解析规则 📝

**目标**: 生成并保存题库专属的解析规则

```
解析规则
↓
保存到: data/config/ccf_parse_rule.json
```

**规则内容**:
```json
{
  "bankName": "CCF",
  "totalQuestions": 50,
  "createdTime": "2024-12-03T10:30:00",
  "modulePatterns": [
    {
      "题干标识": ["【题目描述】", "问题：", "题目："],
      "输入标识": ["【输入】", "输入格式：", "Input:"],
      "输出标识": ["【输出】", "输出格式：", "Output:"],
      "测试数据分隔": ["空行", "测试用例", "样例"],
      "代码限制": ["【时间限制】", "【内存限制】", "支持语言："]
    }
  ],
  "parseMode": "AI智能解析"
}
```

**代码位置**: `SmartQuestionImporter::saveParseRulesAndQuestionBank()`

### 第五步：生成基础题库 📚

**目标**: 将解析后的题目保存为标准化格式

```
解析后的题目
↓
按文件分组
↓
保存到: data/基础题库/{题库名称}/{考试名}/第X题.md
```

**目录结构**:
```
data/基础题库/
└── CCF/
    ├── 考试一/
    │   ├── 第1题.md
    │   ├── 第2题.md
    │   └── 第3题.md
    ├── 考试二/
    │   ├── 第1题.md
    │   └── 第2题.md
    └── 出题模式规律.md
```

**题目文件格式**:
```markdown
# 两数之和

## 题目描述

给定一个整数数组和一个目标值，找出数组中和为目标值的两个数。

## 测试数据

### 测试用例 1 - 基本功能 (原始数据)

**输入：**
```
[2, 7, 11, 15]
9
```

**输出：**
```
[0, 1]
```

### 测试用例 2 - 边界条件 (AI补充)

**输入：**
```
[3, 3]
6
```

**输出：**
```
[0, 1]
```

## 题目信息

- **难度**: 简单
- **标签**: 数组, 哈希表
```

**代码位置**: `SmartQuestionImporter::saveParseRulesAndQuestionBank()`

### 第六步：生成出题模式规律 📊

**目标**: 分析题库特征，生成出题规则文档

```
所有题目
↓
统计分析
↓
保存到: data/基础题库/{题库名称}/出题模式规律.md
```

**分析内容**:
- 题库概况（总题数、平均测试用例数）
- 难度分布（简单/中等/困难的数量和占比）
- 知识点分布（各知识点的题目数）
- 出题规则（套题数量、难度配比建议）
- 测试数据规则（原始数据+AI补充数据）
- 题号专属规则（每题的难度和类型）

**示例输出**:
```markdown
# CCF - 出题模式规律

> 自动生成时间: 2024-12-03 10:35:00

## 📊 题库概况

- **题目总数**: 50 道
- **平均测试用例**: 5.2 组/题

## 📈 难度分布

| 难度 | 数量 | 占比 |
|------|------|------|
| 简单 | 20 | 40% |
| 中等 | 25 | 50% |
| 困难 | 5 | 10% |

## 🏷️ 知识点分布

| 知识点 | 题目数 |
|--------|--------|
| 数组 | 15 |
| 字符串 | 12 |
| 动态规划 | 8 |
| 图论 | 5 |

## 📋 出题规则

### 套题数量
- 每套题目数量: 5 道

### 难度配比建议
- 简单题: 40%
- 中等题: 50%
- 困难题: 10%

### 测试数据规则
- 每题至少 3 组原始测试数据
- AI自动补充 2-3 组边界/异常测试数据
- 测试数据覆盖：基本功能、边界条件、特殊情况
```

**代码位置**: `SmartQuestionImporter::generateExamPattern()`

## 📁 最终目录结构

```
data/
├── 原始题库/              # 只读备份
│   └── CCF/
│       ├── 考试一.md
│       ├── 考试二.md
│       └── 考试三.md
│
├── 基础题库/              # 标准化题库
│   └── CCF/
│       ├── 考试一/
│       │   ├── 第1题.md
│       │   ├── 第2题.md
│       │   └── 第3题.md
│       ├── 考试二/
│       │   ├── 第1题.md
│       │   └── 第2题.md
│       └── 出题模式规律.md
│
├── config/                # 配置文件
│   └── ccf_parse_rule.json
│
└── question_banks/        # 运行时题库
    └── CCF/
        └── questions.json
```

## 🔧 技术实现

### 核心类

1. **SmartQuestionImporter** - 主导入器
   - 协调整个导入流程
   - 管理AI交互
   - 处理文件操作

2. **UniversalQuestionParser** - 通用解析器
   - 识别题目格式
   - 提取结构化信息

3. **QuestionBankAnalyzer** - 题库分析器
   - 统计题库特征
   - 生成分析报告

### 关键函数

```cpp
// 开始导入（完整流程）
void startImportWithUniversalParser(
    const QString &sourcePath,    // 源路径
    const QString &targetPath,    // 目标路径
    const QString &bankName       // 题库名称
);

// 保存解析规则和基础题库
bool saveParseRulesAndQuestionBank();

// 生成出题模式规律
bool generateExamPattern();
```

## 🎯 使用方法

### 用户操作

1. 点击"🤖 AI导入题库"按钮
2. 选择题库文件夹
3. 输入题库名称（如"CCF"）
4. 等待AI自动处理
5. 查看导入结果

### 导入日志示例

```
🚀 开始智能导入流程...

📁 第一步：备份原始题库文件...
  找到 3 个文件
  ✓ 考试一.md
  ✓ 考试二.md
  ✓ 考试三.md
✅ 原始题库已备份到: data/原始题库/CCF
🔒 原始题库已设置为只读

📂 第二步：扫描和分析文件...
  分析: 考试一.md (15234 字符)
    → 拆分为 2 个块
  分析: 考试二.md (8456 字符)
  分析: 考试三.md (12890 字符)
    → 拆分为 2 个块
✅ 文件分析完成，共 5 个文件块

🤖 第三步：AI智能解析题目...

📄 处理: 考试一.md (块 1/2)
  ⏳ 发送AI请求...
  📊 Prompt大小: 15234 字符
  ✓ AI响应接收完成
  ✓ 解析到 3 道题目
    ✓ 两数之和 [简单] - 5个测试用例
    ✓ 反转字符串 [简单] - 5个测试用例
    ✓ 最长公共子序列 [中等] - 6个测试用例

📄 处理: 考试一.md (块 2/2)
  ⏳ 发送AI请求...
  ✓ AI响应接收完成
  ✓ 解析到 2 道题目

... (继续处理其他文件块)

✅ AI解析完成！共导入 15 道题目

📝 第四步：保存解析规则和基础题库...
  ✓ 解析规则已保存: data/config/ccf_parse_rule.json
  📁 基础题库目录: data/基础题库/CCF
  ✓ 考试一: 保存 5 道题目
  ✓ 考试二: 保存 5 道题目
  ✓ 考试三: 保存 5 道题目
  ✅ 共保存 15 道题目到基础题库
✅ 解析规则和基础题库保存完成

📊 第五步：生成出题模式规律...
  ✓ 出题模式规律已保存: data/基础题库/CCF/出题模式规律.md
✅ 出题模式规律生成完成

📊 第六步：生成题库分析报告...
  ✅ 分析报告已保存
  📈 难度分布: 简单 6, 中等 7, 困难 2
  📊 平均测试用例: 5.3 组

🎉 导入完成！
```

## ✅ 验证清单

导入完成后，检查以下内容：

- [ ] `data/原始题库/{题库名}/` 存在且为只读
- [ ] `data/config/ccf_parse_rule.json` 已生成
- [ ] `data/基础题库/{题库名}/` 目录结构正确
- [ ] 每道题目的 `.md` 文件格式正确
- [ ] `出题模式规律.md` 包含完整统计信息
- [ ] 题目包含原始数据和AI补充数据
- [ ] 所有题目都有难度和标签信息

## 🐛 故障排查

### 问题1: 原始题库未保存

**症状**: `data/原始题库/` 目录为空

**解决**:
- 检查源路径是否正确
- 确认有 `.md` 文件
- 查看日志中的拷贝信息

### 问题2: 基础题库未生成

**症状**: `data/基础题库/` 目录为空

**解决**:
- 确认AI解析成功
- 检查 `m_questions` 是否有数据
- 查看 `saveParseRulesAndQuestionBank()` 日志

### 问题3: 解析规则未保存

**症状**: `data/config/ccf_parse_rule.json` 不存在

**解决**:
- 检查 `data/config/` 目录权限
- 确认 JSON 生成逻辑正确
- 查看文件写入错误日志

## 🚀 未来优化

1. **并行处理**: 多个文件块并行发送给AI
2. **增量导入**: 支持追加新题目到现有题库
3. **格式验证**: 导入前验证文件格式
4. **智能去重**: 自动检测重复题目
5. **版本管理**: 题库版本控制和回滚

---

**更新时间**: 2024-12-03  
**版本**: v2.0.0  
**状态**: ✅ 已实现完整流程
