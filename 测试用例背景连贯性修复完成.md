# 测试用例背景连贯性修复完成

## 问题描述

用户报告：**样例输入样例输出模块每行的背景不连贯**

### 问题表现

在题目展示区域的测试用例部分，输入/输出块中的多行文本背景色出现间隙，不连贯。

### 视觉问题

```
输入：
┌─────────────────┐
│ 第一行文本      │  ← 背景色正常
│                 │  ← 这里有间隙！
│ 第二行文本      │  ← 背景色正常
└─────────────────┘
```

---

## 问题分析

### 根本原因

在 `QuestionPanel::setQuestion()` 中，处理测试用例文本时存在冲突：

```cpp
// CSS 设置
.io-block {
    white-space: pre-wrap;  // 已经能自动处理换行
    ...
}

// 但代码中又手动替换换行符
QString inputHtml = tc.input.toHtmlEscaped().replace("\n", "<br>");
```

**问题**:
1. `white-space: pre-wrap` 本身就能正确处理换行符
2. 手动 `replace("\n", "<br>")` 会产生额外的 `<br>` 标签
3. `<br>` 标签会引入额外的行间距
4. 额外的间距导致背景色出现断裂

### 技术细节

**white-space: pre-wrap 的作用**:
- 保留空白符序列
- 保留换行符
- 自动换行（当文本超出容器宽度时）
- 不需要额外的 `<br>` 标签

**replace("\n", "<br>") 的副作用**:
- 将原生换行符替换为HTML换行标签
- `<br>` 标签会产生额外的垂直间距
- 与 `pre-wrap` 的换行机制冲突
- 导致双重换行效果

---

## 解决方案

### 修改内容

**文件**: `src/ui/QuestionPanel.cpp`

**修改前**:
```cpp
// 输入部分
html += "<div class='io-label'>输入：</div>";
QString inputHtml = tc.input.toHtmlEscaped().replace("\n", "<br>");
html += QString("<div class='io-block'>%1</div>").arg(inputHtml);

// 输出部分
html += "<div class='io-label'>输出：</div>";
QString outputHtml = tc.expectedOutput.toHtmlEscaped().replace("\n", "<br>");
html += QString("<div class='io-block'>%1</div>").arg(outputHtml);
```

**修改后**:
```cpp
// 输入部分
html += "<div class='io-label'>输入：</div>";
QString inputHtml = tc.input.toHtmlEscaped();
html += QString("<div class='io-block'>%1</div>").arg(inputHtml);

// 输出部分
html += "<div class='io-label'>输出：</div>";
QString outputHtml = tc.expectedOutput.toHtmlEscaped();
html += QString("<div class='io-block'>%1</div>").arg(outputHtml);
```

**改动**:
- ✅ 移除 `.replace("\n", "<br>")`
- ✅ 保留 `.toHtmlEscaped()`（防止XSS）
- ✅ 让 `white-space: pre-wrap` 自然处理换行

---

## 修复效果

### 修复前
```
输入：
┌─────────────────┐
│ 第一行文本      │
│                 │  ← 有间隙
│ 第二行文本      │
│                 │  ← 有间隙
│ 第三行文本      │
└─────────────────┘
```

### 修复后
```
输入：
┌─────────────────┐
│ 第一行文本      │
│ 第二行文本      │  ← 背景连贯
│ 第三行文本      │
└─────────────────┘
```

**改进**:
- ✅ 背景色完全连贯，无间隙
- ✅ 行间距正常（由 `line-height: 1.6` 控制）
- ✅ 文本选择和复制功能不受影响
- ✅ 保持原有的滚动条样式

---

## 技术说明

### CSS white-space 属性

| 值 | 空白符 | 换行符 | 自动换行 |
|---|---|---|---|
| normal | 合并 | 忽略 | 是 |
| nowrap | 合并 | 忽略 | 否 |
| pre | 保留 | 保留 | 否 |
| pre-wrap | 保留 | 保留 | 是 |
| pre-line | 合并 | 保留 | 是 |

我们使用 `pre-wrap`，因为：
1. 保留原始换行符（不需要 `<br>`）
2. 保留空白符（保持代码格式）
3. 支持自动换行（长行不会溢出）

### 为什么不用 `<br>`？

在 `white-space: pre-wrap` 环境下：
- 原生换行符 `\n` 已经被正确渲染
- 添加 `<br>` 会产生双重换行效果
- `<br>` 的默认 margin 会破坏背景连续性

### HTML转义的重要性

保留 `toHtmlEscaped()` 是必要的：
```cpp
QString inputHtml = tc.input.toHtmlEscaped();  // 必须保留
```

**原因**:
- 防止XSS攻击（如果输入包含 `<script>` 等）
- 正确显示特殊字符（`<`, `>`, `&` 等）
- 不影响换行符的处理

---

## 编译状态

```
[3/3] Linking CXX executable CodePracticeSystem.exe
========================================
编译成功！
========================================
```

✅ 编译成功，无错误

---

## 测试建议

### 功能测试

1. **单行文本**:
   ```
   输入：hello world
   ```
   验证：背景色正常

2. **多行文本**:
   ```
   输入：
   第一行
   第二行
   第三行
   ```
   验证：背景色连贯，无间隙

3. **长文本自动换行**:
   ```
   输入：这是一段很长很长很长很长很长很长很长很长的文本
   ```
   验证：自动换行，背景色连贯

4. **特殊字符**:
   ```
   输入：<html> & "test"
   ```
   验证：特殊字符正确转义显示

5. **复制功能**:
   - 选中多行文本
   - 按 Ctrl+C 复制
   - 粘贴到编辑器
   - 验证：换行符保留，格式正确

### 视觉测试

- [ ] 输入框背景色完全连贯
- [ ] 输出框背景色完全连贯
- [ ] 行间距合理（不过大不过小）
- [ ] 滚动条样式正常
- [ ] 文本可正常选择

---

## 相关CSS属性

### .io-block 完整样式

```css
.io-block {
    background-color: #1e1e1e;      /* 深色背景 */
    padding: 12px;                   /* 内边距 */
    border-radius: 4px;              /* 圆角 */
    margin: 8px 0;                   /* 外边距 */
    font-family: 'Consolas', 'Monaco', monospace;  /* 等宽字体 */
    font-size: 10pt;                 /* 字体大小 */
    line-height: 1.6;                /* 行高（控制行间距）*/
    user-select: text;               /* 允许文本选择 */
    white-space: pre-wrap;           /* 保留换行和空白 */
    word-wrap: break-word;           /* 长单词换行 */
    border: 1px solid #3a3a3a;      /* 边框 */
    color: #e8e8e8;                  /* 文字颜色 */
    max-height: 200px;               /* 最大高度 */
    overflow-y: auto;                /* 垂直滚动 */
    overflow-x: auto;                /* 水平滚动 */
}
```

**关键属性**:
- `white-space: pre-wrap` - 处理换行的核心
- `line-height: 1.6` - 控制行间距
- `background-color: #1e1e1e` - 背景色

---

## 总结

通过移除不必要的 `replace("\n", "<br>")`，让CSS的 `white-space: pre-wrap` 自然处理换行，成功解决了测试用例背景色不连贯的问题。

**修复原理**:
- 避免双重换行机制冲突
- 让CSS原生能力处理文本格式
- 保持代码简洁和可维护性

**修复状态**: ✅ 完成  
**编译状态**: ✅ 成功  
**测试状态**: ⏳ 待用户验证

---

**修复时间**: 2024-12-08  
**问题**: 测试用例背景色不连贯  
**修改文件**: `src/ui/QuestionPanel.cpp`  
**修改行数**: 2行（移除 `.replace("\n", "<br>")`）
