# 难度筛选状态恢复修复

## 问题描述
题目列表的难度筛选在退出程序后重新打开时没有恢复到退出时的状态，总是恢复为默认的"全部选中"状态。

## 根本原因
**真正的问题**：题库树在筛选状态恢复之前就已经加载了！

执行顺序问题：
1. `QuestionBankTreeWidget` 构造函数 → 立即调用 `loadBankTree()`
2. 此时 `m_difficultyFilter` 还是空的（默认显示所有题目）
3. 树加载完成，显示了所有题目
4. `MainWindow` 构造函数 → 调用 `restoreDifficultyFilters()`
5. 筛选状态恢复了，但树已经加载完毕，不会自动刷新

**次要问题**：
- 难度筛选状态的恢复代码只在 `loadLastSession()` 方法中执行
- 只在有保存的会话时才会执行
- 如果用户第一次打开程序或没有会话，筛选状态就不会被恢复

## 解决方案

### 1. 延迟树的加载
**文件**: `src/ui/QuestionBankTreeWidget.cpp`

不在构造函数中立即加载树，等待筛选状态恢复后再加载：

```cpp
QuestionBankTreeWidget::QuestionBankTreeWidget(QWidget *parent)
    : QTreeWidget(parent)
    , m_rootItem(nullptr)
{
    setupUI();
    // 注意：不在构造函数中加载树，等待筛选状态恢复后再加载
    // loadBankTree() 会在 MainWindow 中调用 refreshBankTree() 时执行
}
```

### 2. 在构造函数中恢复筛选状态并刷新树
**文件**: `src/ui/MainWindow.cpp`

将难度筛选状态的恢复移到构造函数中，并立即刷新树：

```cpp
MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , m_currentQuestionIndex(-1)
    , m_aiJudgeProgressDialog(nullptr)
{
    setupUI();
    setupMenuBar();
    setupConnections();
    loadConfiguration();
    
    resize(1400, 800);
    setWindowTitle("代码刷题系统");
    
    // 应用现代化样式
    applyModernStyle();
    
    // 恢复窗口状态
    restoreWindowState();
    
    // 恢复难度筛选状态（在加载题库之前恢复，确保筛选生效）
    QList<int> filterList = SessionManager::instance().loadDifficultyFilters();
    QSet<Difficulty> filters;
    for (int f : filterList) {
        filters.insert(static_cast<Difficulty>(f));
    }
    m_questionBankPanel->restoreDifficultyFilters(filters);
    qDebug() << "[MainWindow] Restored difficulty filters on startup:" << filters.size();
    
    // 初始加载题库树（应用筛选）
    m_questionBankPanel->refreshBankTree();
    
    // 自动加载上次的题库
    loadLastSession();
    
    // 启动时检查AI连接
    QTimer::singleShot(500, this, &MainWindow::checkAIConnection);
}
```

### 3. 移除重复的恢复代码
**文件**: `src/ui/MainWindow.cpp`

在 `loadLastSession()` 中移除重复的难度筛选恢复代码，添加注释说明：

```cpp
// 恢复题库面板状态（展开的文件夹和选中的题目）
QStringList expandedPaths;
QString selectedQuestionPath;
if (SessionManager::instance().loadPanelState(expandedPaths, selectedQuestionPath)) {
    m_questionBankPanel->restoreExpandedPaths(expandedPaths);
    if (!selectedQuestionPath.isEmpty()) {
        m_questionBankPanel->selectQuestion(selectedQuestionPath);
    }
    qDebug() << "[MainWindow] Restored panel state - Expanded:" << expandedPaths.size() << "Selected:" << selectedQuestionPath;
}

// 注意：难度筛选状态已在构造函数中恢复，这里不需要重复恢复
```

## 修改的文件
1. `src/ui/QuestionBankTreeWidget.cpp` - 移除构造函数中的 `loadBankTree()` 调用
2. `src/ui/MainWindow.cpp` - 在恢复筛选状态后立即刷新树，移除重复代码

## 技术细节

### 恢复时机
**之前（错误）**：
```
MainWindow构造函数
  ↓
setupUI() - 创建题库面板
  ↓
  QuestionBankTreeWidget构造函数
    ↓
    loadBankTree() ❌ (此时筛选还未恢复，加载了所有题目)
  ↓
loadLastSession() - 加载会话
  ↓
  如果有会话 && 加载成功
    ↓
    恢复难度筛选 ❌ (太晚了，树已经加载完毕)
```

**现在（正确）**：
```
MainWindow构造函数
  ↓
setupUI() - 创建题库面板
  ↓
  QuestionBankTreeWidget构造函数
    ↓
    setupUI() ✅ (只设置UI，不加载树)
  ↓
恢复难度筛选 ✅ (设置筛选条件)
  ↓
refreshBankTree() ✅ (应用筛选条件加载树)
  ↓
loadLastSession() - 加载会话
```

### 为什么在加载题库之前恢复
1. **确保筛选生效**：在加载题库时，筛选条件已经设置好
2. **避免重复刷新**：不需要先加载所有题目再筛选
3. **性能更好**：直接加载符合筛选条件的题目
4. **逻辑清晰**：筛选是UI状态，应该先恢复UI再加载数据

### 数据流程
1. 程序启动 → `MainWindow` 构造函数
2. 创建UI组件 → `setupUI()`
3. 恢复难度筛选 → `restoreDifficultyFilters()`
4. 加载题库 → `loadLastSession()`
5. 题库树刷新 → 应用筛选条件

## 测试步骤
1. 打开程序，选择一个题库
2. 取消勾选"简单"难度，只保留"中等"和"困难"
3. 验证题目列表只显示中等和困难题目
4. 关闭程序
5. 重新打开程序
6. 验证难度筛选状态是否保持（应该只勾选"中等"和"困难"）
7. 验证题目列表是否只显示中等和困难题目

## 预期结果
- ✅ 程序启动时自动恢复上次的难度筛选状态
- ✅ 无论是否有保存的会话都能恢复
- ✅ 筛选状态在题库加载前就已设置好
- ✅ 题目列表立即显示符合筛选条件的题目
- ✅ 不会出现"先显示所有题目再筛选"的闪烁

## 编译状态
✅ 编译成功，无错误无警告

## 用户体验改进
- **一致性**：退出时的筛选状态完全保持
- **可靠性**：每次启动都能正确恢复
- **流畅性**：不会看到题目列表的闪烁或重新加载
- **符合预期**：用户设置的筛选条件被记住

## 调试日志
启动时会输出：
```
[MainWindow] Restored difficulty filters on startup: 2
[SessionManager] Loaded difficulty filters: [1, 2]
[QuestionBankPanel] Restored difficulty filters: 2
[QuestionBankTreeWidget] Difficulty filter set. Active filters: 2
```

## 相关功能
- 难度筛选功能（题库难度筛选功能完成.md）
- 会话管理（SessionManager）
- 题库面板状态恢复

## 后续优化建议
1. 添加"重置筛选"按钮，快速恢复默认状态
2. 在状态栏显示当前筛选条件
3. 支持快捷键切换筛选状态
4. 添加筛选预设（如"只看未完成"、"只看困难题"等）
