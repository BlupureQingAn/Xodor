# 题库管理模块功能职责分析

## 当前架构概览

项目中存在**三个**与题库相关的UI组件，它们的职责存在**重叠和混乱**：

### 1. QuestionBankManagerDialog（题库管理对话框）
**位置**：`src/ui/QuestionBankManagerDialog.h/cpp`
**调用入口**：文件菜单 → 题库管理 (Ctrl+M)

**当前职责**：
- ✅ 显示所有已注册题库列表
- ✅ 切换题库
- ✅ 查看题库详情（题目统计、完成度、路径信息）
- ✅ 删除题库（从管理器注销）
- ✅ 重命名题库
- ✅ 刷新题库题目数量
- ✅ 导出题库路径
- ✅ 导入新题库（跳转到导入功能）

**数据源**：`QuestionBankManager::instance().getAllBanks()`
**特点**：使用题库管理器的注册信息，支持题库元数据管理

---

### 2. QuestionBankPanel（题库面板）
**位置**：`src/ui/QuestionBankPanel.h/cpp`
**显示位置**：主窗口左侧面板

**当前职责**：
- ⚠️ **双模式设计**：
  - **题目列表模式**：显示当前题库的题目列表
  - **题库列表模式**：显示 `data/基础题库/` 下的所有题库
- ⚠️ 题库列表模式功能：
  - 加载题库
  - 删除题库（直接删除文件）
  - 重命名题库（直接重命名文件夹）
- ✅ 题目列表模式功能：
  - 搜索题目
  - 难度筛选
  - 显示题目状态
  - 选择题目
  - 删除题目

**数据源**：
- 题目模式：`setQuestions()` 传入
- 题库模式：直接扫描 `data/基础题库/` 目录

**问题**：
- ❌ 题库模式与 QuestionBankManagerDialog 功能重复
- ❌ 不使用 QuestionBankManager，直接操作文件系统
- ❌ 双模式设计增加复杂度

---

### 3. QuestionListWidget（题目列表组件）
**位置**：`src/ui/QuestionListWidget.cpp`（没有对应的.h文件？）

**当前职责**：
- ⚠️ **双模式设计**（与 QuestionBankPanel 完全相同）：
  - **题目列表模式**
  - **题库列表模式**
- ⚠️ 功能与 QuestionBankPanel 几乎完全重复

**问题**：
- ❌ 与 QuestionBankPanel 功能完全重复
- ❌ 代码冗余
- ❌ 维护困难

---

### 4. PracticeWidget（刷题练习界面）
**位置**：`src/ui/PracticeWidget.h/cpp`
**显示位置**：主窗口中央区域（练习模式）

**当前职责**：
- ✅ 显示题目表格（带完成度、难度、标签等）
- ✅ 题目筛选和排序
- ✅ 题库选择器（ComboBox）
- ✅ 统计信息显示
- ✅ 随机题目、推荐题目
- ✅ 导出进度报告
- ✅ 批量标记状态
- ⚠️ 切换题库按钮（信号：`switchBankRequested()`）

**数据源**：
- 题库：`QuestionBank *m_questionBank`
- 题库列表：扫描 `data/基础题库/` 目录

**问题**：
- ⚠️ 题库切换功能与 QuestionBankManagerDialog 重叠

---

## 问题总结

### 🔴 严重问题

1. **QuestionBankPanel 和 QuestionListWidget 功能完全重复**
   - 两个组件实现了几乎相同的功能
   - 代码冗余，维护成本高
   - 容易导致行为不一致

2. **题库管理逻辑分散**
   - QuestionBankManagerDialog 使用 QuestionBankManager
   - QuestionBankPanel/QuestionListWidget 直接扫描文件系统
   - 数据源不统一，可能导致不一致

3. **职责不清晰**
   - 题库切换功能在多个地方都有
   - 题库删除/重命名在多个地方实现
   - 没有明确的"单一职责"

### 🟡 中等问题

4. **双模式设计过于复杂**
   - QuestionBankPanel 的双模式增加了复杂度
   - 模式切换逻辑容易出错

5. **数据同步问题**
   - QuestionBankManager 的注册信息可能与文件系统不同步
   - 直接文件操作不会更新 QuestionBankManager

---

## 建议的架构重构

### 方案A：统一题库管理（推荐）

#### 职责划分

**1. QuestionBankManagerDialog（题库管理中心）**
- 唯一的题库管理入口
- 所有题库级别的操作（切换、删除、重命名、导入）
- 使用 QuestionBankManager 作为唯一数据源
- 显示详细的题库信息和统计

**2. QuestionBankPanel（简化为题目列表面板）**
- **移除题库列表模式**
- 只保留题目列表功能
- 专注于题目的显示、筛选、选择
- 不再处理题库级别的操作

**3. 删除 QuestionListWidget**
- 功能完全由 QuestionBankPanel 替代
- 减少代码冗余

**4. PracticeWidget（刷题练习界面）**
- 保留题库选择器（只读，用于快速切换）
- 切换题库时调用 QuestionBankManagerDialog
- 专注于刷题功能

#### 数据流

```
QuestionBankManager (单一数据源)
         ↓
QuestionBankManagerDialog (题库管理)
         ↓
MainWindow (协调)
         ↓
    ┌────┴────┐
    ↓         ↓
QuestionBankPanel  PracticeWidget
(题目列表)      (刷题界面)
```

---

### 方案B：保留双模式（不推荐）

如果必须保留 QuestionBankPanel 的双模式：

1. **统一数据源**
   - 题库模式也使用 QuestionBankManager
   - 不直接扫描文件系统

2. **删除 QuestionListWidget**
   - 避免重复代码

3. **明确职责**
   - QuestionBankManagerDialog：详细管理
   - QuestionBankPanel：快速切换

---

## 具体修复建议

### 立即修复（高优先级）

1. **删除 QuestionListWidget 或合并到 QuestionBankPanel**
   ```cpp
   // 检查 QuestionListWidget 是否还在使用
   // 如果没有使用，直接删除
   // 如果有使用，替换为 QuestionBankPanel
   ```

2. **QuestionBankPanel 移除题库列表模式**
   ```cpp
   // 删除 PanelMode::QuestionBanks 模式
   // 删除 setMode() 函数
   // 删除题库相关的按钮和槽函数
   // 简化为纯题目列表面板
   ```

3. **统一题库操作入口**
   ```cpp
   // 所有题库切换、删除、重命名操作
   // 都通过 QuestionBankManagerDialog 进行
   ```

### 中期优化（中优先级）

4. **QuestionBankPanel 使用 QuestionBankManager**
   - 如果保留题库模式，改用 QuestionBankManager 获取题库列表
   - 不直接扫描文件系统

5. **PracticeWidget 题库选择器改为只读**
   - 点击切换按钮时打开 QuestionBankManagerDialog
   - 不在 PracticeWidget 中实现题库切换逻辑

### 长期改进（低优先级）

6. **添加题库观察者模式**
   ```cpp
   // QuestionBankManager 发出信号
   // 所有UI组件监听并自动更新
   ```

7. **题库缓存机制**
   - 避免重复加载题库
   - 提高性能

---

## 当前状态评估

| 组件 | 职责清晰度 | 代码质量 | 维护性 | 建议 |
|------|-----------|---------|--------|------|
| QuestionBankManagerDialog | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 保留，作为唯一管理入口 |
| QuestionBankPanel | ⭐⭐ | ⭐⭐⭐ | ⭐⭐ | 简化，移除题库模式 |
| QuestionListWidget | ⭐ | ⭐⭐ | ⭐ | 删除，功能重复 |
| PracticeWidget | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 保留，移除题库管理功能 |

---

## 实施步骤

### 第一步：检查 QuestionListWidget 使用情况
```bash
# 搜索 QuestionListWidget 的使用
grep -r "QuestionListWidget" src/
```

### 第二步：确认是否可以删除
- 如果没有被使用 → 直接删除
- 如果被使用 → 替换为 QuestionBankPanel

### 第三步：简化 QuestionBankPanel
- 移除 PanelMode::QuestionBanks
- 删除题库相关功能
- 专注于题目列表

### 第四步：测试
- 题库切换功能
- 题目列表显示
- 刷题功能

---

## 结论

当前题库管理模块存在**职责重叠**和**代码冗余**问题，建议：

1. ✅ **保留** QuestionBankManagerDialog 作为唯一的题库管理入口
2. ✅ **简化** QuestionBankPanel 为纯题目列表面板
3. ✅ **删除** QuestionListWidget（如果存在且功能重复）
4. ✅ **统一** 使用 QuestionBankManager 作为数据源

这样可以：
- 职责清晰，易于维护
- 减少代码冗余
- 避免数据不一致
- 提高用户体验
