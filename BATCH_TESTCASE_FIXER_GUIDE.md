# 批量测试用例修复工具使用指南

## 功能简介

批量测试用例修复工具可以自动扫描整个题库，找出所有有问题的测试用例，并使用 AI 批量修复。

## 使用方法

### 1. 打开批量修复工具

在主菜单中选择：**题目(Q) → 批量修复测试用例(B)...**

或使用快捷键：`Ctrl+Shift+F`

### 2. 扫描题库

点击 **🔍 扫描问题** 按钮，工具会自动扫描 `data/questions` 目录下的所有题目。

扫描会检测以下问题：
- 输入或输出包含省略号（`...`）
- 包含未展开的"重复"标记
- 包含中文括号（可能是注释）
- 输入或输出数据过短
- 输出为空

### 3. 查看扫描结果

扫描完成后，左侧列表会显示所有需要修复的题目，格式为：
```
序号. 题目标题 (问题数量)
```

### 4. 开始批量修复

点击 **🚀 开始批量修复** 按钮，工具会：
1. 依次处理每个有问题的题目
2. 自动调用 AI 生成修复方案
3. 解析 AI 响应并应用修复
4. 保存修复后的题目文件
5. 显示修复进度和日志

### 5. 监控修复过程

- **进度条**：显示整体修复进度
- **状态标签**：显示当前正在处理的题目
- **日志区域**：显示详细的修复日志

### 6. 停止修复

如果需要中途停止，点击 **⏹ 停止** 按钮。

### 7. 重新加载题库

批量修复完成后，建议重新加载题库以查看更新：
- 菜单：**文件(F) → 刷新题库(R)**
- 快捷键：`Ctrl+F5`

## 修复原理

### 检测规则

工具会检测以下类型的问题：

1. **省略号问题**
   - 输入：`1 2 3 ... 100`
   - 修复：展开为完整数据

2. **重复标记问题**
   - 输入：`1 0\n（重复100次）`
   - 修复：展开为100行完整数据

3. **中文括号问题**
   - 输入：`5（数组长度）`
   - 修复：移除注释，保留数据

4. **数据不完整**
   - 输入过短或输出为空
   - 修复：根据题目要求补全数据

### AI 修复流程

1. **生成提示词**：包含题目信息和有问题的测试用例
2. **调用 AI**：使用配置的 AI 服务（Ollama 或云端 AI）
3. **解析响应**：提取 JSON 格式的修复数据
4. **应用修复**：更新测试用例并保存文件

### JSON 响应格式

AI 需要返回以下格式的 JSON：

```json
[
    {
        "index": 1,
        "description": "测试用例描述",
        "input": "完整的输入数据",
        "output": "期望输出"
    }
]
```

## 注意事项

1. **备份数据**：批量修复会直接修改题目文件，建议先备份
2. **AI 配置**：确保已正确配置 AI 服务（设置 → AI 配置）
3. **网络连接**：使用云端 AI 时需要稳定的网络连接
4. **检查结果**：修复完成后建议手动检查几个题目
5. **重新加载**：修复后需要重新加载题库才能看到更新

## 优势对比

### 单个修复 vs 批量修复

| 特性 | 单个修复 | 批量修复 |
|------|---------|---------|
| 适用场景 | 修复单个题目 | 修复整个题库 |
| 操作步骤 | 需要逐个选择题目 | 一键扫描和修复 |
| 效率 | 较低 | 高效 |
| 适合数量 | 1-5 个题目 | 10+ 个题目 |

### 使用建议

- **少量题目**：使用单个修复工具（工具 → 修复测试用例）
- **大量题目**：使用批量修复工具（题目 → 批量修复测试用例）
- **新导入题库**：建议先批量扫描，统一修复

## 故障排除

### 问题：扫描没有发现问题

**原因**：题库中的测试用例都是正常的

**解决**：无需修复

### 问题：AI 调用失败

**原因**：
- AI 服务未配置
- 网络连接问题
- API 密钥错误

**解决**：
1. 检查 AI 配置（设置 → AI 配置）
2. 测试 AI 连接
3. 查看错误日志

### 问题：JSON 解析失败

**原因**：AI 返回的格式不正确

**解决**：
1. 检查 AI 模型是否支持 JSON 输出
2. 尝试使用更强大的模型
3. 查看日志中的 AI 响应内容

### 问题：修复后题目仍有问题

**原因**：AI 修复不完整或不正确

**解决**：
1. 使用单个修复工具手动检查
2. 调整 AI 提示词
3. 手动编辑题目文件

## 技术细节

### 文件结构

```
src/ui/
├── BatchTestCaseFixerDialog.h      # 批量修复对话框头文件
├── BatchTestCaseFixerDialog.cpp    # 批量修复对话框实现
└── TestCaseFixerDialog.cpp         # 单个修复对话框（已更新）
```

### 关键类

- `BatchTestCaseFixerDialog`：批量修复对话框
- `TestCaseFixer`：测试用例修复器（核心逻辑）
- `OllamaClient`：AI 客户端

### 信号与槽

```cpp
// AI 响应信号
void OllamaClient::streamingChunk(const QString &chunk);
void OllamaClient::streamingFinished();
void OllamaClient::error(const QString &error);

// 批量修复槽函数
void BatchTestCaseFixerDialog::onAIChunk(const QString &chunk);
void BatchTestCaseFixerDialog::onAIFinished();
void BatchTestCaseFixerDialog::onAIError(const QString &error);
```

## 更新日志

### v1.0.0 (2024-12-04)
- ✨ 新增批量测试用例修复功能
- ✨ 自动扫描整个题库
- ✨ 支持批量 AI 修复
- ✨ 实时显示修复进度和日志
- ✨ 支持中途停止修复
- 🔧 优化单个修复工具，自动调用 AI

## 相关文档

- [测试用例修复指南](TEST_CASE_FIXER_GUIDE.md)
- [AI 配置指南](AI_CONFIG_GUIDE.md)
- [题库管理指南](QUESTION_BANK_GUIDE.md)
