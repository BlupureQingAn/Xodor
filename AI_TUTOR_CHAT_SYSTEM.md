# AI导师对话系统设计

## 功能概述
将AI分析面板改造为智能对话助手，采用费曼学习法引导用户独立思考和解决问题。

## 核心特性

### 1. 对话触发方式
- **主动触发**：用户随时可以在侧边栏输入问题
- **被动触发**：代码测试失败时，AI主动询问"需要帮助吗？"

### 2. 对话历史管理
- 按题目ID保存对话历史
- 切换题目时自动加载该题的历史对话
- 支持开启新对话（清空当前会话，但保留历史）
- 历史记录保存在 `data/conversations/{questionId}.json`

### 3. 界面布局（类似ChatGPT）
```
┌─────────────────────────────────┐
│ 🤖 AI 导师    [🆕 新对话] [📜]  │
├─────────────────────────────────┤
│                                 │
│  [对话消息流式显示区域]          │
│  - 用户消息（右对齐，蓝色）      │
│  - AI消息（左对齐，绿色）        │
│  - 流式输出实时更新              │
│                                 │
│                                 │
├─────────────────────────────────┤
│ [💡 分析代码] [💭 思路] [📚 知识点]│
├─────────────────────────────────┤
│ [输入框...            ] [发送]  │
└─────────────────────────────────┘
```

### 4. 费曼学习法系统提示词
```
你是一位经验丰富的编程导师，采用费曼学习法教学。

核心原则：
1. 永远不要直接给出答案或完整代码
2. 通过提问引导学生思考
3. 让学生用自己的话解释概念和思路
4. 根据学生的回答质量调整引导程度

教学策略：
- 学生回答正确：鼓励并深入提问
- 学生回答模糊：引导其更清晰地表达
- 学生回答错误：不直接指出，而是反问让其发现问题
- 学生完全卡住：给出小提示，但不超过30%的信息

对话风格：
- 友好、耐心、鼓励
- 使用苏格拉底式提问
- 适当使用emoji增加亲和力
```

### 5. 自适应引导程度
根据用户回答质量动态调整：

**高质量回答**（理解深入）：
- 提问频率：高
- 深度：增加难度，探讨边界情况
- 示例："很好！那如果输入规模达到10^6呢？"

**中等质量回答**（基本理解）：
- 提问频率：中等
- 深度：巩固理解，补充细节
- 示例："不错！能说说为什么选择这个数据结构吗？"

**低质量回答**（理解不足）：
- 提问频率：降低
- 深度：给出更多提示和引导
- 示例："让我们从简单的例子开始..."

## 技术实现

### 1. 流式输出
```cpp
// OllamaClient添加流式响应信号
signal void streamingResponse(const QString &chunk);

// AIAssistantPanel实时追加
connect(m_aiClient, &OllamaClient::streamingResponse, 
        this, &AIAssistantPanel::onStreamingChunk);
```

### 2. 对话历史结构
```json
{
  "questionId": "q001",
  "messages": [
    {
      "role": "user",
      "content": "这道题我不知道怎么做",
      "timestamp": "2024-12-03T14:30:00"
    },
    {
      "role": "assistant",
      "content": "别着急，我们一起来分析。首先，你能用自己的话说说题目要求什么吗？",
      "timestamp": "2024-12-03T14:30:05"
    }
  ],
  "userLevel": "beginner",  // 用户水平评估
  "questionCount": 5         // AI提问次数
}
```

### 3. 代码错误主动询问
```cpp
// 在MainWindow::onRunTests中
if (allTestsFailed) {
    m_aiPanel->offerHelp("看起来测试没有通过，需要我帮你分析一下吗？");
}
```

### 4. 快捷按钮功能
- **💡 分析代码**：预设问题"请帮我分析一下代码"
- **💭 思路**：预设问题"我不知道怎么做，能给我一些思路吗？"
- **📚 知识点**：预设问题"这道题涉及哪些知识点？"

## 修改的文件

### 新增/修改
1. `src/ui/AIAssistantPanel.h` - 重构对话面板
2. `src/ui/AIAssistantPanel.cpp` - 实现流式对话
3. `src/ai/AIAssistant.h` - 添加费曼学习法支持
4. `src/ai/AIAssistant.cpp` - 实现自适应引导
5. `src/ai/OllamaClient.h` - 添加流式响应信号
6. `src/ai/OllamaClient.cpp` - 实现流式输出

### 修改
1. `src/ui/MainWindow.cpp` - 移除导入时的AI输出显示，添加错误主动询问
2. `src/ui/SmartImportDialog.cpp` - 导入进度只显示在状态栏

## 用户体验流程

### 场景1：用户主动提问
```
用户：这道题我不会做
AI：别担心！让我们一起来分析。首先，你能用自己的话说说题目要求什么吗？
用户：就是要找最大值
AI：很好！那你觉得应该怎么找最大值呢？有什么想法吗？
用户：遍历数组？
AI：👍 思路对了！那遍历的时候需要记录什么信息呢？
```

### 场景2：代码测试失败
```
[测试失败]
AI：我注意到测试没有通过。需要我帮你看看吗？
用户：好的
AI：在我们分析之前，你能先说说你的代码思路是什么吗？
用户：我想用循环找最大值
AI：嗯，思路是对的。那你觉得哪里可能出问题了呢？
```

### 场景3：快捷分析
```
[用户点击"💡 分析代码"]
AI：好的，让我看看你的代码。在分析之前，你能先说说：
   1. 你的算法思路是什么？
   2. 你觉得代码哪里可能有问题？
   
   这样我能更好地帮助你！
```

## 实现优先级

### Phase 1（核心功能）
- [x] 重构AIAssistantPanel为对话界面
- [ ] 实现流式输出
- [ ] 添加费曼学习法系统提示词
- [ ] 按题目保存对话历史

### Phase 2（交互优化）
- [ ] 代码错误主动询问
- [ ] 快捷按钮预设问题
- [ ] 新对话功能
- [ ] 历史记录查看

### Phase 3（智能化）
- [ ] 自适应引导程度
- [ ] 用户水平评估
- [ ] 对话质量分析

## 注意事项
1. 流式输出要平滑，避免闪烁
2. 对话历史文件大小控制（每题最多100条消息）
3. AI响应速度优化（使用较小的模型）
4. 错误处理要友好（网络断开、AI服务不可用等）
