# AI导入MD拆分 - 当前策略和测试指南

## ✅ 已完成的修复

### 问题
用户反馈：明明有5道题，但只识别到3道题。

### 根本原因
- 识别到的题目数量 = 分隔符数量 + 1
- 3道题 = 2个分隔符（应该是4个分隔符）
- **结论**：AI只输出了2个分隔符

### 解决方案

#### 1. 改进AI提示词（核心修复）

**文件**: `src/ai/SmartQuestionImporter.cpp:387-467`

**关键改进**：

1. **明确分隔符数量规则**
```
【分隔符使用规则 - 极其重要】
1. 分隔符格式：---QUESTION_SEPARATOR---（必须完全一致）
2. 分隔符位置：每道题的末尾，独占一行
3. 分隔符数量：如果有N道题，必须有N-1个分隔符
   - 2道题 = 1个分隔符
   - 3道题 = 2个分隔符
   - 4道题 = 3个分隔符
   - 5道题 = 4个分隔符
4. 最后一道题后面不需要分隔符
```

2. **提供完整的输出示例**
```
【输出示例 - 3道题的情况】
---
title: "第一题"
...
---QUESTION_SEPARATOR---
---
title: "第二题"
...
---QUESTION_SEPARATOR---
---
title: "第三题"
...
```

3. **添加最终检查清单**
```
【最终检查清单】
在输出前，请确认：
✓ 每道题都有完整的Front Matter
✓ 题目内容完全复制原文
✓ 每道题都有至少5组测试用例
✓ 题目之间使用了正确的分隔符
✓ 分隔符数量 = 题目数量 - 1
✓ 没有任何额外的说明文字
```

#### 2. 支持分隔符变体（容错机制）

**文件**: `src/ai/SmartQuestionImporter.cpp:517-548`

**支持的分隔符格式**：
- `---QUESTION_SEPARATOR---` （标准格式）
- `--- QUESTION SEPARATOR ---` （有空格）
- `---question_separator---` （小写）
- `===QUESTION_SEPARATOR===` （不同符号）
- `---QUESTION-SEPARATOR---` （连字符）

**自动检测逻辑**：
```cpp
QString actualSeparator = "---QUESTION_SEPARATOR---";
if (separatorCount == 0) {
    // 检测各种变体
    if (variant1 > 0) {
        actualSeparator = "--- QUESTION SEPARATOR ---";
        separatorCount = variant1;
        emit logMessage("⚠️ 使用变体分隔符（有空格）");
    }
    // ... 其他变体
}

// 使用实际找到的分隔符进行拆分
QStringList questionBlocks = response.split(actualSeparator, Qt::SkipEmptyParts);
```

## 📊 诊断日志

### 正常情况（5道题，4个分隔符）

```
✓ AI响应接收完成 (12345 字符)
📝 响应开头: ---...
📝 第2行: title: "两数之和"...
📝 最后一行: **说明**: 特殊情况

📊 AI响应总长度: 12345 字符
🔍 找到 4 个分隔符 (---QUESTION_SEPARATOR---)
💡 预期题目数量: 5 道
✓ 实际识别到 5 道题目，开始解析并保存...

📄 处理第 1/5 个块，长度: 2500 字符
✓ 第 1 个块: 两数之和 [简单]
    🟢 两数之和 [简单] - 5个测试用例 ✓已保存

📄 处理第 2/5 个块，长度: 2600 字符
✓ 第 2 个块: 三数之和 [中等]
    🟡 三数之和 [中等] - 5个测试用例 ✓已保存

📄 处理第 3/5 个块，长度: 2400 字符
✓ 第 3 个块: 四数之和 [中等]
    🟡 四数之和 [中等] - 5个测试用例 ✓已保存

📄 处理第 4/5 个块，长度: 2700 字符
✓ 第 4 个块: 最长回文子串 [困难]
    🔴 最长回文子串 [困难] - 5个测试用例 ✓已保存

📄 处理第 5/5 个块，长度: 2800 字符
✓ 第 5 个块: 正则表达式匹配 [困难]
    🔴 正则表达式匹配 [困难] - 5个测试用例 ✓已保存

✅ 成功保存 5 道题目
```

### 异常情况（分隔符不足）

```
📊 AI响应总长度: 8000 字符
🔍 找到 2 个分隔符 (---QUESTION_SEPARATOR---)
💡 预期题目数量: 3 道  ← ⚠️ 问题：应该是5道
✓ 实际识别到 3 道题目，开始解析并保存...

📄 处理第 1/3 个块
✓ 第 1 个块: 两数之和 [简单]

📄 处理第 2/3 个块
✓ 第 2 个块: 三数之和 [中等]

📄 处理第 3/3 个块
✓ 第 3 个块: 四数之和 [中等]

✅ 成功保存 3 道题目

⚠️ 缺少2道题（最长回文子串、正则表达式匹配）
```

### 使用变体分隔符

```
📊 AI响应总长度: 12000 字符
🔍 找到 0 个分隔符 (---QUESTION_SEPARATOR---)
⚠️ 发现 4 个变体分隔符: '--- QUESTION SEPARATOR ---' (有空格)
💡 使用变体分隔符，预期题目数量: 5 道
✓ 实际识别到 5 道题目，开始解析并保存...

✅ 成功保存 5 道题目
```

## 🧪 测试步骤

### 1. 准备测试数据

创建一个包含5道题的MD文件，例如 `test_5_questions.md`：

```markdown
# 第一题：两数之和

给定一个整数数组和一个目标值...

输入格式：...
输出格式：...

---

# 第二题：三数之和

给定一个包含n个整数的数组...

输入格式：...
输出格式：...

---

# 第三题：四数之和

给定一个包含n个整数的数组...

输入格式：...
输出格式：...

---

# 第四题：最长回文子串

给定一个字符串s...

输入格式：...
输出格式：...

---

# 第五题：正则表达式匹配

给定一个字符串s和一个模式p...

输入格式：...
输出格式：...
```

### 2. 运行导入

1. 启动程序：`build\CodePracticeSystem.exe`
2. 点击"AI智能导入"
3. 选择测试文件
4. 输入题库名称（如"测试题库"）
5. 点击"开始导入"

### 3. 查看日志

重点关注以下信息：

```
🔍 找到 X 个分隔符
💡 预期题目数量: Y 道
```

**预期结果**：
- X = 4（4个分隔符）
- Y = 5（5道题）

### 4. 检查保存的文件

查看 `data/基础题库/测试题库/` 目录：

```
简单/
  两数之和.md
中等/
  三数之和.md
  四数之和.md
困难/
  最长回文子串.md
  正则表达式匹配.md
```

**预期结果**：应该有5个MD文件

### 5. 检查调试响应（如果有问题）

查看 `debug_ai_responses/` 目录中最新的响应文件：

```powershell
# 查看最新的响应文件
Get-ChildItem -Path "debug_ai_responses" | Sort-Object LastWriteTime -Descending | Select-Object -First 1

# 打开文件查看内容
notepad (Get-ChildItem -Path "debug_ai_responses" | Sort-Object LastWriteTime -Descending | Select-Object -First 1).FullName

# 统计分隔符数量
(Get-Content (Get-ChildItem -Path "debug_ai_responses" | Sort-Object LastWriteTime -Descending | Select-Object -First 1).FullName -Raw).Split("---QUESTION_SEPARATOR---").Count - 1
```

## 🔍 问题诊断

### 情况1：分隔符数量不足

**症状**：
```
🔍 找到 2 个分隔符
💡 预期题目数量: 3 道
```

**可能原因**：
1. AI响应被截断（token限制）
2. AI没有理解所有题目
3. AI认为某些内容不是题目

**解决方案**：
1. 查看 `debug_ai_responses/` 中的原始响应
2. 检查响应是否完整
3. 如果被截断，考虑：
   - 增加max_tokens设置
   - 将文件拆分成更小的块
4. 如果AI理解有误，改进提示词

### 情况2：使用了变体分隔符

**症状**：
```
🔍 找到 0 个分隔符
⚠️ 发现 4 个变体分隔符: '--- QUESTION SEPARATOR ---'
💡 使用变体分隔符，预期题目数量: 5 道
```

**结果**：代码自动处理，应该能正常识别

**如果仍有问题**：
- 检查是否有其他未支持的变体
- 在代码中添加新的变体支持

### 情况3：题目格式错误

**症状**：
```
📄 处理第 3/5 个块，长度: 156 字符
⚠️ 第 3 个块格式不正确，跳过
📝 块开头: 好的，我来帮你拆分...
```

**原因**：AI输出了额外的说明文字

**解决方案**：
- 在提示词中强调"不要任何额外文字"
- 或者在代码中过滤掉这些内容

## 📝 编译和运行

### 编译项目

```powershell
cmake --build build --config Release
```

**预期输出**：
```
[1/4] Automatic MOC and UIC for target CodePracticeSystem
[2/3] Building CXX object CMakeFiles/CodePracticeSystem.dir/src/ui/SmartImportDialog.cpp.obj
[3/3] Linking CXX executable CodePracticeSystem.exe
-- Data sync completed.

========================================
构建成功！
========================================

可执行文件位置: build\CodePracticeSystem.exe
```

### 运行程序

```powershell
.\build\CodePracticeSystem.exe
```

## 🎯 预期效果

### 改进后的AI行为

1. **明确理解分隔符规则**
   - 知道必须使用 `---QUESTION_SEPARATOR---`
   - 知道分隔符数量 = 题目数量 - 1
   - 知道分隔符必须独占一行

2. **提供完整输出**
   - 输出所有5道题
   - 每道题之间都有分隔符
   - 没有遗漏或截断

3. **格式一致**
   - 使用标准分隔符格式
   - 即使使用变体，代码也能识别

### 改进后的代码行为

1. **自动检测分隔符变体**
   - 支持5种常见的分隔符格式
   - 自动选择正确的分隔符进行拆分
   - 显示使用的分隔符类型

2. **详细的诊断日志**
   - 显示找到的分隔符数量
   - 显示预期的题目数量
   - 显示每个块的处理情况

3. **保存原始响应**
   - 便于事后分析
   - 便于调试和改进

## 🚀 后续优化建议

### 如果问题仍然存在

1. **增加Token限制**
```cpp
// 在OllamaClient中设置
m_aiClient->setMaxTokens(16000);  // 增加到16000
```

2. **要求AI先声明题目数量**
在提示词开头添加：
```
请在开头说明题目总数，格式：【题目总数：5】
```

3. **分块处理大文件**
如果文件太大，将其拆分成更小的块，每块处理2-3道题。

4. **添加验证和重试机制**
```cpp
if (questionBlocks.size() < expectedCount) {
    emit logMessage("⚠️ 题目数量不足，尝试重新解析...");
    // 重试逻辑
}
```

## 📊 总结

✅ **已完成**：
- 改进AI提示词，明确分隔符规则和数量要求
- 提供完整的输出示例和检查清单
- 支持5种分隔符变体，自动检测和使用
- 增强诊断日志，显示分隔符数量和预期题目数
- 保存原始响应用于调试
- 编译成功

✅ **核心改进**：
- **明确的数量规则**：N道题 = N-1个分隔符
- **完整的示例**：展示3道题的完整输出格式
- **检查清单**：AI输出前的自我检查
- **容错机制**：支持多种分隔符变体

🎯 **预期结果**：
- 能够正确识别5道题
- 每道题都能成功保存
- 日志显示 "🔍 找到 4 个分隔符" 和 "💡 预期题目数量: 5 道"
- 生成5个独立的MD文件

⏭️ **下一步**：
1. 运行测试，使用包含5道题的MD文件
2. 查看详细日志，确认分隔符数量
3. 检查保存的文件数量
4. 如果仍有问题，查看 `debug_ai_responses/` 中的原始响应
5. 根据具体情况采取进一步措施
