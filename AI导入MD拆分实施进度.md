# AI导入MD拆分 - 题目丢失问题修复

## 问题描述

用户反馈：明明有5道题，但只识别到3道题。

## 根本原因分析

**数学关系**：识别到的题目数量 = 分隔符数量 + 1

- 识别到3道题 → 只有2个分隔符
- 应该识别5道题 → 需要4个分隔符

**结论**：AI只输出了2个分隔符，导致只能识别出3道题。

## 可能的原因

### 1. AI没有理解分隔符的重要性
- AI可能认为分隔符是可选的
- AI可能忘记在某些题目之间添加分隔符

### 2. AI响应被截断
- Token限制导致响应不完整
- 最后几道题没有输出完整

### 3. AI使用了不同格式的分隔符
- 添加了空格：`--- QUESTION SEPARATOR ---`
- 使用了小写：`---question_separator---`
- 使用了其他符号：`===QUESTION_SEPARATOR===`

## 已实施的修复

### 修复1：改进AI提示词

**位置**: `src/ai/SmartQuestionImporter.cpp:387-467`

**改进内容**：

1. **明确分隔符规则**
```
【分隔符使用规则 - 极其重要】
1. 分隔符格式：---QUESTION_SEPARATOR---（必须完全一致）
2. 分隔符位置：每道题的末尾，独占一行
3. 分隔符数量：如果有N道题，必须有N-1个分隔符
   - 2道题 = 1个分隔符
   - 3道题 = 2个分隔符
   - 4道题 = 3个分隔符
   - 5道题 = 4个分隔符
4. 最后一道题后面不需要分隔符
```

2. **提供完整示例**
```
【输出示例 - 3道题的情况】
---
title: "第一题"
...
---QUESTION_SEPARATOR---
---
title: "第二题"
...
---QUESTION_SEPARATOR---
---
title: "第三题"
...
```

3. **添加检查清单**
```
【最终检查清单】
在输出前，请确认：
✓ 每道题都有完整的Front Matter
✓ 题目内容完全复制原文
✓ 每道题都有至少5组测试用例
✓ 题目之间使用了正确的分隔符
✓ 分隔符数量 = 题目数量 - 1
✓ 没有任何额外的说明文字
```

### 修复2：支持分隔符变体

**位置**: `src/ai/SmartQuestionImporter.cpp:517-548`

**改进内容**：

自动检测并支持多种分隔符格式：

```cpp
QString actualSeparator = "---QUESTION_SEPARATOR---";
if (separatorCount == 0) {
    // 检测变体1：有空格
    int variant1 = response.count("--- QUESTION SEPARATOR ---");
    // 检测变体2：小写
    int variant2 = response.count("---question_separator---");
    // 检测变体3：不同符号
    int variant3 = response.count("===QUESTION_SEPARATOR===");
    // 检测变体4：连字符
    int variant4 = response.count("---QUESTION-SEPARATOR---");
    
    // 使用找到的变体
    if (variant1 > 0) {
        actualSeparator = "--- QUESTION SEPARATOR ---";
        separatorCount = variant1;
    }
    // ... 其他变体
}

// 使用实际找到的分隔符进行拆分
QStringList questionBlocks = response.split(actualSeparator, Qt::SkipEmptyParts);
```

**支持的分隔符格式**：
- `---QUESTION_SEPARATOR---` （标准格式）
- `--- QUESTION SEPARATOR ---` （有空格）
- `---question_separator---` （小写）
- `===QUESTION_SEPARATOR===` （不同符号）
- `---QUESTION-SEPARATOR---` （连字符）

## 诊断日志增强

### 正常情况（5道题，4个分隔符）

```
✓ AI响应接收完成 (12345 字符)
📝 响应开头: ---...
📝 第2行: title: "两数之和"...
📝 最后一行: **说明**: 特殊情况

📊 AI响应总长度: 12345 字符
🔍 找到 4 个分隔符 (---QUESTION_SEPARATOR---)
💡 预期题目数量: 5 道
✓ 实际识别到 5 道题目，开始解析并保存...

📄 处理第 1/5 个块，长度: 2500 字符
✓ 第 1 个块: 两数之和 [简单]
    🟢 两数之和 [简单] - 5个测试用例 ✓已保存

📄 处理第 2/5 个块，长度: 2600 字符
✓ 第 2 个块: 三数之和 [中等]
    🟡 三数之和 [中等] - 5个测试用例 ✓已保存

📄 处理第 3/5 个块，长度: 2400 字符
✓ 第 3 个块: 四数之和 [中等]
    🟡 四数之和 [中等] - 5个测试用例 ✓已保存

📄 处理第 4/5 个块，长度: 2700 字符
✓ 第 4 个块: 最长回文子串 [困难]
    🔴 最长回文子串 [困难] - 5个测试用例 ✓已保存

📄 处理第 5/5 个块，长度: 2800 字符
✓ 第 5 个块: 正则表达式匹配 [困难]
    🔴 正则表达式匹配 [困难] - 5个测试用例 ✓已保存

✅ 成功保存 5 道题目
```

### 异常情况1：分隔符不足（只有2个）

```
📊 AI响应总长度: 8000 字符
🔍 找到 2 个分隔符 (---QUESTION_SEPARATOR---)
💡 预期题目数量: 3 道  ← 问题：应该是5道
✓ 实际识别到 3 道题目，开始解析并保存...

📄 处理第 1/3 个块
✓ 第 1 个块: 两数之和 [简单]

📄 处理第 2/3 个块
✓ 第 2 个块: 三数之和 [中等]

📄 处理第 3/3 个块
✓ 第 3 个块: 四数之和 [中等]

✅ 成功保存 3 道题目

⚠️ 问题：缺少2道题（最长回文子串、正则表达式匹配）
```

### 异常情况2：使用了变体分隔符

```
📊 AI响应总长度: 12000 字符
🔍 找到 0 个分隔符 (---QUESTION_SEPARATOR---)
⚠️ 发现 4 个变体分隔符: '--- QUESTION SEPARATOR ---' (有空格)
💡 使用变体分隔符，预期题目数量: 5 道
✓ 实际识别到 5 道题目，开始解析并保存...

✅ 成功保存 5 道题目
```

## 调试步骤

### 1. 重新编译项目

```powershell
cd build
cmake --build . --config Release
```

### 2. 运行导入测试

准备一个包含5道题的MD文件，运行AI导入功能。

### 3. 查看日志

重点关注：
```
🔍 找到 X 个分隔符
💡 预期题目数量: Y 道
```

如果 Y < 5，说明有问题。

### 4. 检查保存的响应文件

查看 `debug_ai_responses/` 目录中最新的响应文件：

```powershell
# 查看最新的响应文件
Get-ChildItem -Path "debug_ai_responses" | Sort-Object LastWriteTime -Descending | Select-Object -First 1

# 统计分隔符数量
(Get-Content "debug_ai_responses/response_xxx.txt" -Raw).Split("---QUESTION_SEPARATOR---").Count - 1
```

### 5. 分析原因

根据日志和响应文件，判断：

**情况A：分隔符数量不足**
- 原因：AI没有输出所有题目
- 解决：检查响应是否被截断，或AI是否理解了所有题目

**情况B：使用了变体分隔符**
- 原因：AI使用了不同格式的分隔符
- 解决：代码已自动支持，应该能正常识别

**情况C：响应被截断**
- 原因：Token限制
- 解决：增加max_tokens设置，或将文件拆分成更小的块

## 预期效果

### 改进后的AI行为

1. **明确理解分隔符规则**
   - 知道必须使用 `---QUESTION_SEPARATOR---`
   - 知道分隔符数量 = 题目数量 - 1
   - 知道分隔符必须独占一行

2. **提供完整输出**
   - 输出所有5道题
   - 每道题之间都有分隔符
   - 没有遗漏或截断

3. **格式一致**
   - 使用标准分隔符格式
   - 即使使用变体，代码也能识别

### 改进后的代码行为

1. **自动检测分隔符变体**
   - 支持5种常见的分隔符格式
   - 自动选择正确的分隔符进行拆分

2. **详细的诊断日志**
   - 显示找到的分隔符数量
   - 显示预期的题目数量
   - 显示使用的分隔符格式

3. **保存原始响应**
   - 便于事后分析
   - 便于调试和改进

## 后续优化建议

### 如果问题仍然存在

1. **增加Token限制**
```cpp
// 在发送AI请求时
m_aiClient->setMaxTokens(16000);  // 增加到16000
```

2. **要求AI先声明题目数量**
```
请在开头说明题目总数，格式：【题目总数：5】
```

3. **分块处理**
如果文件太大，将其拆分成更小的块，每块处理2-3道题。

4. **添加验证机制**
```cpp
// 验证题目数量
if (questionBlocks.size() < expectedCount) {
    emit logMessage("⚠️ 警告：题目数量不足，可能有题目丢失");
    // 可以选择重试或提示用户
}
```

## 总结

✅ **已完成**：
- 改进AI提示词，明确分隔符规则
- 提供完整的输出示例
- 添加最终检查清单
- 支持5种分隔符变体
- 自动检测并使用正确的分隔符

✅ **诊断能力**：
- 精确统计分隔符数量
- 显示预期题目数量
- 检测分隔符变体
- 保存原始响应用于调试

⏳ **下一步**：
1. 重新编译项目
2. 运行导入测试
3. 查看详细日志
4. 检查是否识别到5道题
5. 如果仍有问题，查看 `debug_ai_responses/` 中的原始响应

🎯 **预期结果**：
- 能够正确识别5道题
- 每道题都能成功保存
- 日志显示 "🔍 找到 4 个分隔符" 和 "💡 预期题目数量: 5 道"
