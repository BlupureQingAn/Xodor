# 题库面板删除与撤销功能完成

## 实现内容
第四阶段：**删除与撤销（实现删除到回收站和 Ctrl+Z 撤销）**

## 功能描述

### 1. 删除到回收站
- 删除题目或题库时，不直接删除文件
- 将文件/文件夹移动到回收站（`data/recycle_bin/`）
- 添加时间戳避免文件名冲突
- 保留完整的文件结构

### 2. 撤销/重做
- **Ctrl+Z**：撤销上一次操作
- **Ctrl+Shift+Z**：重做上一次撤销的操作
- 支持多次撤销/重做
- 最多保存 50 条操作历史

### 3. 操作历史
- 记录所有删除、创建、编辑操作
- 显示操作时间和描述
- 可视化当前位置
- 支持清空历史

### 4. 支持的操作类型
- **删除题目**：可撤销
- **删除题库**：可撤销
- **创建题目**：可撤销（删除创建的文件）
- **编辑题目**：可撤销（恢复旧内容）

## 实现细节

### 1. OperationHistory 类

**文件**：`src/utils/OperationHistory.h`, `src/utils/OperationHistory.cpp`

#### 核心结构

```cpp
// 操作类型
enum class OperationType {
    DeleteQuestion,     // 删除题目
    DeleteBank,         // 删除题库
    CreateQuestion,     // 创建题目
    EditQuestion        // 编辑题目
};

// 操作记录
struct Operation {
    OperationType type;
    QString description;        // 操作描述
    QDateTime timestamp;        // 操作时间
    QJsonObject data;          // 操作数据
    
    // 删除操作的数据
    QString filePath;          // 被删除的文件/文件夹路径
    QString backupPath;        // 备份路径（回收站）
    QByteArray fileContent;    // 文件内容（用于恢复）
    bool isDirectory;          // 是否是目录
};
```

#### 单例模式

```cpp
class OperationHistory : public QObject
{
    Q_OBJECT
    
public:
    static OperationHistory& instance();
    
    // 记录操作
    void recordDeleteQuestion(const QString &filePath, const QByteArray &content);
    void recordDeleteBank(const QString &bankPath);
    void recordCreateQuestion(const QString &filePath);
    void recordEditQuestion(const QString &filePath, const QByteArray &oldContent);
    
    // 撤销/重做
    bool canUndo() const;
    bool canRedo() const;
    bool undo();
    bool redo();
    
    // 清空历史
    void clear();
};
```

### 2. 删除到回收站

#### 文件删除

```cpp
bool OperationHistory::deleteFileToRecycleBin(const QString &filePath, QString &backupPath)
{
    // 创建回收站目录
    QString recycleBin = "data/recycle_bin";
    QDir dir(recycleBin);
    if (!dir.exists()) {
        dir.mkpath(".");
    }
    
    // 生成备份文件名（添加时间戳避免冲突）
    QString timestamp = QDateTime::currentDateTime().toString("yyyyMMdd_hhmmss");
    QString backupFileName = QString("%1_%2").arg(timestamp).arg(fileInfo.fileName());
    backupPath = recycleBin + "/" + backupFileName;
    
    // 移动文件到回收站
    return QFile::rename(filePath, backupPath);
}
```

#### 目录删除

```cpp
bool OperationHistory::deleteDirectoryToRecycleBin(const QString &dirPath, QString &backupPath)
{
    // 创建回收站目录
    QString recycleBin = "data/recycle_bin";
    
    // 生成备份目录名（添加时间戳）
    QString timestamp = QDateTime::currentDateTime().toString("yyyyMMdd_hhmmss");
    QString backupDirName = QString("%1_%2").arg(timestamp).arg(dirInfo.fileName());
    backupPath = recycleBin + "/" + backupDirName;
    
    // 移动目录到回收站
    return QDir().rename(dirPath, backupPath);
}
```

### 3. 撤销实现

```cpp
bool OperationHistory::undo()
{
    if (!canUndo()) {
        return false;
    }
    
    Operation op = m_history[m_currentIndex];
    bool success = false;
    
    switch (op.type) {
        case OperationType::DeleteQuestion:
        case OperationType::DeleteBank:
            // 恢复被删除的文件/目录
            if (op.isDirectory) {
                success = restoreDirectory(op.filePath, op.backupPath);
            } else {
                success = restoreFile(op.filePath, op.fileContent);
            }
            break;
            
        case OperationType::CreateQuestion:
            // 删除创建的文件
            success = QFile::remove(op.filePath);
            break;
            
        case OperationType::EditQuestion:
            // 恢复旧内容
            success = restoreFile(op.filePath, op.fileContent);
            break;
    }
    
    if (success) {
        m_currentIndex--;
        emit operationUndone(op);
        emit historyChanged();
    }
    
    return success;
}
```

### 4. 文件恢复

```cpp
bool OperationHistory::restoreFile(const QString &filePath, const QByteArray &content)
{
    // 确保目录存在
    QFileInfo fileInfo(filePath);
    QDir dir = fileInfo.dir();
    if (!dir.exists()) {
        dir.mkpath(".");
    }
    
    // 写入文件
    QFile file(filePath);
    if (file.open(QIODevice::WriteOnly)) {
        file.write(content);
        file.close();
        return true;
    }
    
    return false;
}
```

### 5. 目录恢复

```cpp
bool OperationHistory::restoreDirectory(const QString &dirPath, const QString &backupPath)
{
    if (backupPath.isEmpty() || !QDir(backupPath).exists()) {
        return false;
    }
    
    // 确保父目录存在
    QFileInfo dirInfo(dirPath);
    QDir parentDir = dirInfo.dir();
    if (!parentDir.exists()) {
        parentDir.mkpath(".");
    }
    
    // 复制回收站中的目录
    return copyDirectory(backupPath, dirPath);
}
```

### 6. 持久化

操作历史保存到 `data/operation_history.json`：

```json
{
    "currentIndex": 2,
    "history": [
        {
            "type": 0,
            "description": "删除题目: 树上搜索.json",
            "timestamp": "2025-12-05T22:30:00",
            "filePath": "data/基础题库/CCF/树上搜索.json",
            "backupPath": "data/recycle_bin/20251205_223000_树上搜索.json",
            "fileContent": "...",
            "isDirectory": false
        }
    ]
}
```

### 7. MainWindow 集成

#### 菜单项

```cpp
// 编辑菜单
QMenu *editMenu = menuBar()->addMenu("编辑(&E)");

QAction *undoAction = editMenu->addAction("撤销(&U)");
undoAction->setShortcut(QKeySequence("Ctrl+Z"));
connect(undoAction, &QAction::triggered, this, &MainWindow::onUndo);

QAction *redoAction = editMenu->addAction("重做(&R)");
redoAction->setShortcut(QKeySequence("Ctrl+Shift+Z"));
connect(redoAction, &QAction::triggered, this, &MainWindow::onRedo);

QAction *historyAction = editMenu->addAction("操作历史(&H)...");
historyAction->setShortcut(QKeySequence("Ctrl+H"));
connect(historyAction, &QAction::triggered, this, &MainWindow::onShowOperationHistory);
```

#### 撤销实现

```cpp
void MainWindow::onUndo()
{
    if (OperationHistory::instance().canUndo()) {
        if (OperationHistory::instance().undo()) {
            // 刷新题库面板
            if (m_questionBankPanel) {
                m_questionBankPanel->refreshBankTree();
            }
            statusBar()->showMessage("✅ 操作已撤销", 3000);
        } else {
            QMessageBox::warning(this, "撤销失败", "无法撤销此操作");
        }
    } else {
        statusBar()->showMessage("没有可撤销的操作", 2000);
    }
}
```

#### 操作历史对话框

显示所有操作记录，当前位置用黄色高亮，已撤销的操作用灰色显示。

### 8. QuestionBankTreeWidget 更新

#### 删除题目

```cpp
void QuestionBankTreeWidget::onDeleteQuestion()
{
    // 读取文件内容用于撤销
    QFile file(filePath);
    QByteArray content;
    if (file.open(QIODevice::ReadOnly)) {
        content = file.readAll();
        file.close();
    }
    
    // 使用 OperationHistory 删除（移动到回收站）
    OperationHistory::instance().recordDeleteQuestion(filePath, content);
    
    refreshTree();
    QMessageBox::information(this, "成功", "题目已删除\n\n按 Ctrl+Z 可撤销此操作");
}
```

#### 删除题库

```cpp
void QuestionBankTreeWidget::onDeleteBank()
{
    // 使用 OperationHistory 删除（移动到回收站）
    OperationHistory::instance().recordDeleteBank(bankPath);
    
    refreshTree();
    QMessageBox::information(this, "成功", "题库已删除\n\n按 Ctrl+Z 可撤销此操作");
}
```

## 数据结构

### 回收站目录结构

```
data/
├── recycle_bin/
│   ├── 20251205_223000_树上搜索.json
│   ├── 20251205_223100_CCF/
│   │   ├── 题目1.json
│   │   ├── 题目2.json
│   │   └── ...
│   └── ...
└── operation_history.json
```

### 操作历史文件

```json
{
    "currentIndex": 2,
    "history": [
        {
            "type": 0,
            "description": "删除题目: 树上搜索.json",
            "timestamp": "2025-12-05T22:30:00",
            "filePath": "data/基础题库/CCF/树上搜索.json",
            "backupPath": "data/recycle_bin/20251205_223000_树上搜索.json",
            "fileContent": "base64_encoded_content",
            "isDirectory": false
        },
        {
            "type": 1,
            "description": "删除题库: CCF",
            "timestamp": "2025-12-05T22:31:00",
            "filePath": "data/基础题库/CCF",
            "backupPath": "data/recycle_bin/20251205_223100_CCF",
            "isDirectory": true
        },
        {
            "type": 2,
            "description": "创建题目: 新题目.json",
            "timestamp": "2025-12-05T22:32:00",
            "filePath": "data/基础题库/测试/新题目.json",
            "isDirectory": false
        }
    ]
}
```

## 工作流程

### 删除题目流程
1. 用户右键点击题目，选择"删除题目"
2. 显示确认对话框
3. 读取文件内容
4. 调用 `OperationHistory::recordDeleteQuestion()`
5. 文件移动到回收站（添加时间戳）
6. 记录操作到历史
7. 刷新树形列表
8. 显示成功消息（提示可撤销）

### 撤销删除流程
1. 用户按 Ctrl+Z
2. 调用 `OperationHistory::undo()`
3. 从历史中获取最后一次操作
4. 根据操作类型执行恢复：
   - 删除操作：从回收站恢复文件/目录
   - 创建操作：删除创建的文件
   - 编辑操作：恢复旧内容
5. 更新当前索引
6. 刷新树形列表
7. 显示成功消息

### 重做流程
1. 用户按 Ctrl+Shift+Z
2. 调用 `OperationHistory::redo()`
3. 获取下一个操作
4. 重新执行该操作
5. 更新当前索引
6. 刷新树形列表
7. 显示成功消息

## 技术亮点

### 1. 时间戳避免冲突
```cpp
QString timestamp = QDateTime::currentDateTime().toString("yyyyMMdd_hhmmss");
QString backupFileName = QString("%1_%2").arg(timestamp).arg(fileInfo.fileName());
```

### 2. 递归目录复制
```cpp
bool copyDirectory(const QString &source, const QString &destination)
{
    // 复制文件
    QFileInfoList files = sourceDir.entryInfoList(QDir::Files);
    for (const QFileInfo &fileInfo : files) {
        QFile::copy(srcPath, dstPath);
    }
    
    // 递归复制子目录
    QFileInfoList dirs = sourceDir.entryInfoList(QDir::Dirs | QDir::NoDotAndDotDot);
    for (const QFileInfo &dirInfo : dirs) {
        copyDirectory(srcPath, dstPath);
    }
}
```

### 3. 历史记录限制
```cpp
// 限制历史记录数量
if (m_history.size() > MAX_HISTORY_SIZE) {
    m_history.removeFirst();
    m_currentIndex--;
}
```

### 4. 分支历史处理
```cpp
// 如果当前不在历史末尾，删除后面的记录
if (m_currentIndex < m_history.size() - 1) {
    m_history.erase(m_history.begin() + m_currentIndex + 1, m_history.end());
}
```

### 5. 信号通知
```cpp
signals:
    void historyChanged();
    void operationUndone(const Operation &op);
    void operationRedone(const Operation &op);
```

## 用户体验

### 之前
- 删除操作不可撤销
- 误删除后无法恢复
- 没有操作历史记录

### 现在
- ✅ 删除移动到回收站
- ✅ Ctrl+Z 撤销删除
- ✅ Ctrl+Shift+Z 重做
- ✅ 查看操作历史
- ✅ 最多保存 50 条历史
- ✅ 自动刷新界面
- ✅ 友好的提示消息

## 安全性

### 1. 数据保护
- 删除操作不直接删除文件
- 文件保存在回收站
- 可随时恢复

### 2. 冲突处理
- 时间戳避免文件名冲突
- 自动创建必要的目录

### 3. 错误处理
- 文件操作失败时显示错误
- 撤销失败时保持状态不变

## 测试建议

1. **删除题目测试**
   - 删除单个题目
   - 验证文件移动到回收站
   - 验证树形列表刷新

2. **删除题库测试**
   - 删除整个题库
   - 验证目录移动到回收站
   - 验证所有文件都被保留

3. **撤销测试**
   - 删除后立即撤销
   - 验证文件恢复到原位置
   - 验证内容完整

4. **多次撤销测试**
   - 执行多个操作
   - 连续撤销多次
   - 验证每次都正确恢复

5. **重做测试**
   - 撤销后重做
   - 验证操作重新执行
   - 验证状态正确

6. **历史记录测试**
   - 查看操作历史
   - 验证当前位置高亮
   - 验证已撤销操作显示为灰色

7. **边界测试**
   - 达到最大历史记录数
   - 验证旧记录被删除
   - 清空历史记录

8. **冲突测试**
   - 同名文件删除
   - 验证时间戳避免冲突
   - 验证都能正确恢复

## 相关文件

### 新增文件
- `src/utils/OperationHistory.h` - 操作历史管理器头文件
- `src/utils/OperationHistory.cpp` - 操作历史管理器实现

### 修改文件
- `src/ui/QuestionBankTreeWidget.h` - 添加撤销支持
- `src/ui/QuestionBankTreeWidget.cpp` - 使用 OperationHistory
- `src/ui/MainWindow.h` - 添加撤销/重做方法
- `src/ui/MainWindow.cpp` - 实现撤销/重做功能

### 数据文件
- `data/recycle_bin/` - 回收站目录
- `data/operation_history.json` - 操作历史文件

## 状态
✅ **第四阶段完成** - 删除与撤销功能已实现

## 总结

所有四个阶段已全部完成：
1. ✅ 第一阶段：题库树形结构
2. ✅ 第二阶段：会话保存与恢复
3. ✅ 第三阶段：新增题目功能
4. ✅ 第四阶段：删除与撤销功能

左侧题库面板现在具备完整的题库管理功能！
