# 编码问题解决方案总结

## 问题现状

### 核心问题
`MainWindow.cpp` 文件中的中文字符串已经永久损坏（出现"锟斤拷"乱码），无法通过编码转换修复。

### 原因分析
1. 文件原本可能是GB2312/GBK编码
2. 被错误地当作UTF-8读取并保存
3. 中文字符在转换过程中损坏

## 已完成的工作

### 1. 项目UTF-8配置 ✅

**CMakeLists.txt**
```cmake
# MinGW/GCC编译器UTF-8配置
add_compile_options(-finput-charset=UTF-8)
add_compile_options(-fexec-charset=UTF-8)
add_compile_options(-fwide-exec-charset=UTF-8)
add_compile_definitions(_UNICODE UNICODE)
add_link_options(-municode)
```

### 2. 终端UTF-8配置脚本 ✅

创建了3个配置脚本：
- `configure_utf8.ps1` - PowerShell全自动配置
- `fix_utf8_encoding.bat` - CMD批处理配置
- `convert_to_utf8.ps1` - 批量文件编码转换

### 3. IDE配置 ✅

创建了 `.vscode/settings.json.recommended`：
- 文件编码：UTF-8
- 终端编码：UTF-8
- CMake环境变量：LANG=zh_CN.UTF-8

### 4. 题库面板重命名 ✅

- `QuestionListWidget` → `QuestionBankPanel`
- `ListMode` → `PanelMode`
- 所有相关文件和引用已更新

## 解决方案

### 方案A：从备份/Git恢复（推荐）

如果有版本控制或备份：
```powershell
# Git恢复
git checkout HEAD -- src/ui/MainWindow.cpp

# 或从备份复制
Copy-Item backup/MainWindow.cpp src/ui/MainWindow.cpp
```

### 方案B：手动修复中文字符串

需要修复约23处中文字符串，包括：
- 对话框标题和消息
- 状态栏提示
- 日志输出
- 错误提示

**修复步骤：**
1. 打开 `src/ui/MainWindow.cpp`
2. 搜索"锟斤拷"
3. 根据上下文恢复正确的中文
4. 确保编辑器使用UTF-8编码保存

### 方案C：重构代码（长期方案）

将所有UI字符串提取到资源文件：
```cpp
// 使用Qt的翻译系统
tr("确定要删除题目吗？")

// 或使用QString::fromUtf8
QString::fromUtf8("确定要删除题目吗？")
```

## 编译流程

### 使用自动脚本（推荐）

```powershell
# 1. 修复MainWindow.cpp中的中文字符串（手动）

# 2. 运行配置脚本
.\configure_utf8.ps1

# 脚本会自动：
# - 设置终端UTF-8编码
# - 清理旧的构建文件
# - 重新配置CMake
# - 编译项目
```

### 手动编译

```powershell
# 1. 设置UTF-8编码
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
[Console]::InputEncoding = [System.Text.Encoding]::UTF8
chcp 65001

# 2. 清理
Remove-Item -Recurse -Force build, .cache

# 3. 配置
cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Debug

# 4. 编译
cmake --build build
```

## 预防措施

### 1. 确保所有文件UTF-8编码

```powershell
# 批量转换（预览）
.\convert_to_utf8.ps1 -DryRun

# 实际转换
.\convert_to_utf8.ps1
```

### 2. Git配置

创建 `.gitattributes`：
```
*.cpp text eol=lf encoding=utf-8
*.h text eol=lf encoding=utf-8
*.c text eol=lf encoding=utf-8
```

### 3. 编辑器配置

确保IDE/编辑器：
- 默认编码：UTF-8（无BOM）
- 行尾符：LF
- 自动检测编码：关闭

## 验证清单

- [ ] 终端编码是UTF-8 (chcp 65001)
- [ ] 所有源文件是UTF-8编码
- [ ] MainWindow.cpp中文字符串已修复
- [ ] CMake配置成功
- [ ] 编译成功（无编码错误）
- [ ] 程序运行正常
- [ ] 界面中文显示正确

## 快速参考

### 检查终端编码
```powershell
chcp  # 应显示: 65001
```

### 检查文件编码
```powershell
# 检查是否有BOM
$bytes = [System.IO.File]::ReadAllBytes("file.cpp")
$bytes[0..2]  # 不应该是 EF BB BF
```

### 重新编译
```powershell
.\configure_utf8.ps1
```

## 相关文档

- `UTF8编码配置指南.md` - 详细配置说明
- `UTF8编码修复完成说明.md` - 修复进度和待办事项
- `题库面板重命名完成.md` - 重命名工作总结

## 总结

### 配置工作：100% 完成 ✅
- CMake UTF-8配置
- 终端UTF-8配置
- IDE配置建议
- 自动化脚本

### 代码修复：需要手动处理 ⚠️
- MainWindow.cpp 中约23处中文字符串需要修复
- 建议从备份/Git恢复，或手动重新输入

### 下一步
1. **修复 MainWindow.cpp 中的中文字符串**（必须）
2. 运行 `.\configure_utf8.ps1` 编译
3. 测试程序功能
4. 提交代码到版本控制

---

**重要提示：** 所有UTF-8配置已完成，但 `MainWindow.cpp` 中的中文字符串已损坏，必须手动修复后才能成功编译。
