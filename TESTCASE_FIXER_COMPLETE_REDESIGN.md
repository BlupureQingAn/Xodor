# 测试用例修复工具完全重新设计

## 概述

完全重新设计测试用例修复工具，实现真正的统一交互流程：
1. ✅ 菜单中只有一个入口
2. ✅ 手动选择要检查的题目
3. ✅ 点击"扫描问题"检测
4. ✅ 显示检测结果
5. ✅ 点击"修复选中"修复有问题的题目

## 核心设计理念

### 用户完全控制

**之前的问题：**
- 打开对话框自动检测/扫描
- 用户无法选择要检查哪些题目
- 强制检查所有题目或当前题目

**现在的设计：**
- 打开对话框显示所有题目列表
- 用户手动选择要检查的题目（支持多选）
- 点击"扫描问题"才开始检测
- 只修复有问题的题目

### 统一的交互流程

```
打开工具
    ↓
显示所有题目列表（带复选框）
    ↓
用户选择要检查的题目
    ↓
点击"扫描问题"按钮
    ↓
检测选中题目的测试用例
    ↓
显示检测结果（哪些题目有问题）
    ↓
点击"修复选中"按钮
    ↓
自动修复有问题的题目
    ↓
完成，自动刷新题库
```

## 新的UI设计

### 完整界面布局

```
┌─────────────────────────────────────────────────────────────┐
│ 🔧 测试用例修复工具                                          │
│ 选择要检查的题目，点击'扫描问题'检测测试用例问题...          │
├─────────────────────────────────────────────────────────────┤
│ 就绪                                    已选择: 3 个题目     │
│ [=========>          ] 1/3 - 33%                            │
├──────────────────────┬──────────────────────────────────────┤
│ 题目列表：  [全选][取消]│ 详细信息：                          │
│                      │                                      │
│ ☐ 数组操作题         │ 选择题目后，点击'扫描问题'查看检测结果...│
│ ☑ 字符串处理         │                                      │
│ ☑ 图论算法           │                                      │
│ ☑ 动态规划           │                                      │
│ ☐ 贪心算法           │                                      │
│ ...                  │                                      │
│                      │                                      │
├──────────────────────┴──────────────────────────────────────┤
│ [🔍 扫描问题] [🚀 修复选中] [⏹ 停止]            [关闭]      │
├─────────────────────────────────────────────────────────────┤
│ 处理日志：                                                   │
│ 等待操作...                                                  │
└─────────────────────────────────────────────────────────────┘
```

### 扫描后的界面

```
┌─────────────────────────────────────────────────────────────┐
│ 🔧 测试用例修复工具                                          │
│ 选择要检查的题目，点击'扫描问题'检测测试用例问题...          │
├─────────────────────────────────────────────────────────────┤
│ ⚠️ 发现 2 个题目存在问题                已选择: 3 个题目     │
├──────────────────────┬──────────────────────────────────────┤
│ 题目列表：  [全选][取消]│ 详细信息：                          │
│                      │                                      │
│ ✅ 数组操作题        │ 发现 2 个题目存在测试用例问题：       │
│ ⚠️ 字符串处理 (2个问题)│                                    │
│ ⚠️ 图论算法 (1个问题)│ ⚠️ 字符串处理                        │
│                      │    问题数量：2 个                     │
│                      │                                      │
│                      │ ⚠️ 图论算法                          │
│                      │    问题数量：1 个                     │
│                      │                                      │
│                      │ 点击'修复选中'按钮开始修复。          │
├──────────────────────┴──────────────────────────────────────┤
│ [🔍 扫描问题] [🚀 修复选中] [⏹ 停止]            [关闭]      │
├─────────────────────────────────────────────────────────────┤
│ 处理日志：                                                   │
│ 🔍 开始扫描 3 个题目...                                      │
│ ✅ [1/3] 数组操作题 - 正常                                   │
│ ⚠️ [2/3] 字符串处理 - 发现 2 个问题                         │
│ ⚠️ [3/3] 图论算法 - 发现 1 个问题                           │
│                                                              │
│ ========== 扫描完成 ==========                               │
│ 扫描题目：3 个                                               │
│ 发现问题：2 个                                               │
│ 正常题目：1 个                                               │
└─────────────────────────────────────────────────────────────┘
```

## 交互流程详解

### 1. 打开工具

**菜单：** 工具 → 测试用例修复工具 (Ctrl+Shift+F)

**操作：**
- 加载所有题目到列表
- 每个题目前面有复选框
- 默认全部未选中

### 2. 选择题目

**操作：**
- 手动勾选要检查的题目
- 或点击"全选"按钮
- 或点击"取消"按钮取消所有选择
- 选择标签实时显示："已选择: N 个题目"

### 3. 扫描问题

**点击"扫描问题"按钮：**
- 检测选中题目的测试用例
- 实时显示扫描进度
- 更新列表项显示：
  - ✅ 正常题目（绿色）
  - ⚠️ 有问题的题目（橙色，显示问题数量）
- 显示扫描结果摘要

### 4. 查看结果

**详细信息区域显示：**
- 有问题的题目列表
- 每个题目的问题数量
- 提示点击"修复选中"按钮

**日志区域显示：**
- 每个题目的扫描结果
- 扫描统计信息

### 5. 修复题目

**点击"修复选中"按钮：**
- 只修复有问题的题目
- 显示修复进度条
- 实时显示修复日志
- 可随时点击"停止"按钮

### 6. 完成

**修复完成后：**
- 显示完成提示
- 自动刷新题库
- 可以关闭对话框或继续扫描其他题目

## 技术实现

### 数据结构

```cpp
struct QuestionItem {
    QString id;
    QString title;
    QString filePath;
    bool hasIssues;                    // 是否有问题
    QVector<int> problematicIndices;   // 问题测试用例索引
};

QVector<QuestionItem> m_allQuestions;      // 所有题目
QVector<QuestionItem> m_questionsToFix;    // 需要修复的题目
```

### 核心方法

#### loadAllQuestions()
```cpp
// 加载所有题目到列表
// 每个题目添加复选框
// 默认未选中
```

#### onScanSelected()
```cpp
// 获取选中的题目
// 逐个检测测试用例
// 更新列表项显示（✅ 或 ⚠️）
// 显示扫描结果
```

#### onFixSelected()
```cpp
// 只修复有问题的题目（m_questionsToFix）
// 显示进度条
// 逐个调用AI修复
// 保存修复结果
```

### UI组件

```cpp
QListWidget *m_questionList;        // 题目列表（带复选框）
QTextEdit *m_detailView;            // 详细信息
QTextEdit *m_logView;               // 处理日志
QPushButton *m_scanButton;          // 扫描问题
QPushButton *m_selectAllButton;     // 全选
QPushButton *m_selectNoneButton;    // 取消全选
QPushButton *m_fixButton;           // 修复选中
QPushButton *m_stopButton;          // 停止
QProgressBar *m_progressBar;        // 进度条
QLabel *m_statusLabel;              // 状态标签
QLabel *m_selectionLabel;           // 选择标签
```

### 状态管理

```cpp
bool m_isScanning;   // 是否正在扫描
bool m_isFixing;     // 是否正在修复
int m_currentFixIndex;  // 当前修复索引
```

## 菜单整合

### 之前

```
工具菜单
├── 🔧 修复测试用例
└── 🔧 批量修复测试用例
```

### 现在

```
工具菜单
└── 🔧 测试用例修复工具 (Ctrl+Shift+F)
```

### MainWindow 实现

```cpp
void MainWindow::onFixTestCases()
{
    // 统一的入口
    TestCaseFixerDialog *dialog = new TestCaseFixerDialog(
        m_questionBank, m_ollamaClient, this);
    
    connect(dialog, &TestCaseFixerDialog::questionsFixed, this, [this]() {
        onRefreshQuestionBank();  // 自动刷新
    });
    
    dialog->exec();
}

void MainWindow::onBatchFixTestCases()
{
    // 重定向到统一的工具
    onFixTestCases();
}
```

## 优势对比

### 之前的设计

| 特性 | 单题目修复 | 批量修复 |
|------|-----------|---------|
| 入口 | 2个菜单项 | 2个菜单项 |
| 自动检测 | 是 | 是 |
| 用户选择 | 否 | 否 |
| 检测范围 | 当前题目 | 所有题目 |
| 交互步骤 | 自动 | 自动 |
| 用户控制 | 低 | 低 |

### 现在的设计

| 特性 | 统一工具 |
|------|---------|
| 入口 | 1个菜单项 |
| 自动检测 | 否 |
| 用户选择 | 是（多选） |
| 检测范围 | 用户选择 |
| 交互步骤 | 手动控制 |
| 用户控制 | 高 |

## 使用场景

### 场景1：检查单个题目

1. 打开工具
2. 勾选一个题目
3. 点击"扫描问题"
4. 如果有问题，点击"修复选中"

### 场景2：检查所有题目

1. 打开工具
2. 点击"全选"
3. 点击"扫描问题"
4. 查看结果，点击"修复选中"

### 场景3：检查特定题目

1. 打开工具
2. 勾选感兴趣的题目（如：所有字符串题）
3. 点击"扫描问题"
4. 查看结果，点击"修复选中"

### 场景4：分批检查

1. 打开工具
2. 勾选前10个题目
3. 点击"扫描问题"
4. 修复有问题的
5. 取消全选，勾选下10个题目
6. 重复

## 检测逻辑

### 只检测明确的问题

```cpp
// 省略号
if (tc.input.contains("...")) hasIssue = true;

// 重复标记
if (tc.input.contains("（重复") || tc.input.contains("(重复")) 
    hasIssue = true;

// 省略标记
if (tc.input.contains("省略")) hasIssue = true;

// AI生成但过短
if (tc.isAIGenerated && tc.input.trimmed().length() < 5) 
    hasIssue = true;

// 智能检测：描述说有很多行，但实际只有一行
QStringList inputLines = tc.input.split('\n', Qt::SkipEmptyParts);
if (inputLines.size() == 1 && tc.description.contains("行") && 
    (tc.description.contains("100") || tc.description.contains("1000"))) {
    hasIssue = true;
}
```

## 测试要点

### 基本功能

- [ ] 打开工具显示所有题目
- [ ] 复选框可以勾选/取消
- [ ] 全选/取消全选按钮工作正常
- [ ] 选择标签实时更新

### 扫描功能

- [ ] 扫描按钮只在有选择时可用
- [ ] 扫描过程显示进度
- [ ] 扫描结果正确显示
- [ ] 列表项颜色正确更新
- [ ] 详细信息正确显示

### 修复功能

- [ ] 修复按钮只在有问题时可用
- [ ] 修复过程显示进度条
- [ ] 修复日志实时更新
- [ ] 停止按钮工作正常
- [ ] 修复完成自动刷新

### 边界情况

- [ ] 没有选择题目时提示
- [ ] 所有题目都正常时提示
- [ ] AI调用失败时处理
- [ ] 保存失败时处理

## 优势总结

1. **真正统一** - 一个入口，一个工具，一套流程
2. **用户控制** - 用户决定检查哪些题目
3. **灵活高效** - 可以检查单个、多个或全部题目
4. **清晰反馈** - 每一步都有明确的状态和结果
5. **易于使用** - 交互流程简单直观
6. **功能完整** - 保留所有原有功能

## 与之前版本的对比

| 方面 | 之前 | 现在 |
|------|------|------|
| 菜单项数量 | 2个 | 1个 |
| 自动检测 | 是 | 否（用户控制） |
| 选择题目 | 否 | 是（多选） |
| 检测范围 | 固定 | 灵活 |
| 用户控制 | 低 | 高 |
| 交互步骤 | 自动 | 手动 |
| 代码复杂度 | 高 | 中 |
| 用户体验 | 一般 | 优秀 |

## 后续优化建议

1. 添加搜索/过滤功能
2. 支持按标签筛选题目
3. 添加"只显示有问题的题目"选项
4. 支持导出检测报告
5. 添加修复历史记录
6. 支持批量导入题目列表
