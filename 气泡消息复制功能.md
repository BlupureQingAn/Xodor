# AI导师气泡消息复制功能 + Markdown渲染优化

## 问题描述

### 问题1：无法复制文本
使用自定义Delegate绘制的聊天气泡，文本是直接画上去的，不是真正的文本控件，因此无法选中和复制。

### 问题2：Markdown渲染问题
- 代码块字体过小（10pt），与编辑器字体（11pt）不一致
- 代码块字体不清晰，显示效果差
- 代码块换行处理不正确
- 特殊字符（如分号）显示异常或消失
- HTML特殊字符未转义

## 解决方案

### 方案1：添加右键菜单复制功能
在AIAssistantPanel中添加右键菜单功能，让用户可以通过右键菜单复制消息内容。

### 方案2：优化Markdown渲染
- 统一代码块字体大小为11pt，与编辑器一致
- 使用更清晰的字体渲染设置
- 正确处理HTML特殊字符转义
- 改进代码块样式，添加边框和更好的背景
- 优化换行和空白字符处理

## 实现细节

### 1. 启用自定义右键菜单
```cpp
m_chatListView->setContextMenuPolicy(Qt::CustomContextMenu);
```

### 2. 连接右键菜单信号
```cpp
connect(m_chatListView, &QListView::customContextMenuRequested, 
        this, &AIAssistantPanel::onChatListContextMenu);
```

### 3. 实现右键菜单处理函数
```cpp
void AIAssistantPanel::onChatListContextMenu(const QPoint &pos)
{
    // 获取点击位置的item
    QModelIndex index = m_chatListView->indexAt(pos);
    if (!index.isValid()) {
        return;
    }
    
    // 获取消息内容和角色
    QString role = index.data(Qt::UserRole).toString();
    QString content = index.data(Qt::DisplayRole).toString();
    
    // 系统消息不显示菜单
    if (role == "system" || content.isEmpty()) {
        return;
    }
    
    // 创建右键菜单
    QMenu menu(this);
    QAction *copyOriginalAction = menu.addAction("📋 复制原始消息");
    QAction *copyPlainAction = menu.addAction("📄 复制纯文本");
    
    // 显示菜单并获取选择
    QAction *selectedAction = menu.exec(m_chatListView->mapToGlobal(pos));
    
    if (selectedAction == copyOriginalAction) {
        // 复制原始消息（包含Markdown格式）
        QClipboard *clipboard = QApplication::clipboard();
        clipboard->setText(content);
        QToolTip::showText(m_chatListView->mapToGlobal(pos), 
                          "✅ 已复制原始消息", m_chatListView, QRect(), 1500);
    }
    else if (selectedAction == copyPlainAction) {
        // 复制纯文本（移除Markdown格式）
        QString plainText = content;
        plainText.replace(QRegularExpression("```[^\\n]*\\n"), "");
        plainText.replace("```", "");
        plainText.replace(QRegularExpression("`([^`]+)`"), "\\1");
        plainText.replace(QRegularExpression("\\*\\*([^\\*]+)\\*\\*"), "\\1");
        plainText.replace(QRegularExpression("\\*([^\\*]+)\\*"), "\\1");
        plainText.replace(QRegularExpression("^###? (.+)$", QRegularExpression::MultilineOption), "\\1");
        
        QClipboard *clipboard = QApplication::clipboard();
        clipboard->setText(plainText);
        QToolTip::showText(m_chatListView->mapToGlobal(pos), 
                          "✅ 已复制纯文本", m_chatListView, QRect(), 1500);
    }
}
```

## 功能特性

### 1. 两种复制模式
- **复制原始消息**：保留Markdown格式（代码块、加粗、列表等）
- **复制纯文本**：移除所有Markdown格式标记，只保留纯文本内容

### 2. 智能过滤
- 系统消息不显示右键菜单
- 空消息不显示右键菜单
- 只对用户消息和AI消息显示菜单

### 3. 用户体验
- 美观的深色主题菜单样式
- 复制后显示Toast提示（1.5秒自动消失）
- 菜单项带有emoji图标，更直观

### 4. Markdown格式处理
纯文本模式会移除以下Markdown格式：
- 代码块：\`\`\`language\ncode\n\`\`\`
- 行内代码：\`code\`
- 加粗：\*\*text\*\*
- 斜体：\*text\*
- 标题：## text 或 ### text

## 使用方法

1. 在AI导师对话列表中，右键点击任意消息气泡
2. 选择"📋 复制原始消息"或"📄 复制纯文本"
3. 消息内容已复制到剪贴板，可以粘贴到任何地方

## 技术要点

### 1. 获取点击位置的数据
```cpp
QModelIndex index = m_chatListView->indexAt(pos);
QString role = index.data(Qt::UserRole).toString();      // 角色
QString content = index.data(Qt::DisplayRole).toString(); // 内容
```

### 2. 菜单样式定制
使用QSS样式表定制深色主题菜单，与整体UI风格保持一致。

### 3. Toast提示
使用QToolTip显示临时提示，自动消失，不打断用户操作。

### 4. 正则表达式处理
使用QRegularExpression精准匹配和移除Markdown格式标记。

## 修改的文件

1. **src/ui/AIAssistantPanel.h**
   - 添加QMenu头文件
   - 添加onChatListContextMenu槽函数声明

2. **src/ui/AIAssistantPanel.cpp**
   - 添加QMenu、QClipboard、QApplication、QToolTip头文件
   - 启用自定义右键菜单
   - 连接customContextMenuRequested信号
   - 实现onChatListContextMenu函数

## 测试建议

1. 测试用户消息复制
2. 测试AI消息复制（包含Markdown格式）
3. 测试纯文本模式是否正确移除格式
4. 测试系统消息不显示菜单
5. 测试空白区域不显示菜单
6. 测试Toast提示是否正常显示

## 间距和阅读体验优化

### 优化前的问题
- **行间距过大**：1.7的行高导致文本过于松散，阅读不连贯
- **代码块间距过大**：margin: 10px 0，占用空间太多
- **标题间距过大**：margin: 12-14px，视觉割裂感强
- **列表间距过大**：margin: 5px 0，列表项之间太分散
- **整体不紧凑**：大量空白影响信息密度

### 优化后的改进
- **行间距**：1.7 → 1.4，更紧凑舒适
- **代码块间距**：10px → 8px，padding: 12px → 10px
- **代码块行高**：1.5 → 1.4，与正文一致
- **标题间距**：减小到8-10px和4-5px
- **列表间距**：5px → 2px，列表更紧凑
- **语言标签间距**：margin-bottom: 6px → 4px

### 对比效果
```
优化前：
行高1.7 + 代码块margin 10px + 标题margin 12-14px = 视觉松散，信息密度低

优化后：
行高1.4 + 代码块margin 8px + 标题margin 8-10px = 紧凑舒适，信息密度高
```

## Markdown渲染优化详解

### 1. HTML特殊字符转义
```cpp
// 先转义HTML特殊字符（但保留换行符）
result.replace("&", "&amp;");
result.replace("<", "&lt;");
result.replace(">", "&gt;");
```
这样可以防止代码中的`<`、`>`等字符被误解析为HTML标签，导致内容丢失。

### 2. 代码块处理改进
```cpp
// 使用与编辑器相同的字体和大小
QString codeHtml = QString(
    "<div style='background: rgba(0,0,0,0.5); padding: 12px; border-radius: 6px; "
    "margin: 10px 0; border: 1px solid rgba(255,255,255,0.1);'>"
    "<div style='color: #888; font-size: 9pt; margin-bottom: 6px;'>%1</div>"
    "<pre style='margin: 0; padding: 0; "
    "font-family: \"Consolas\", \"Courier New\", monospace; "
    "font-size: 11pt; line-height: 1.5; "
    "white-space: pre-wrap; word-wrap: break-word; color: #e8e8e8;'>%2</pre>"
    "</div>"
).arg(language.isEmpty() ? "代码" : language, code);
```

关键改进：
- **字体大小**：从10pt改为11pt，与编辑器一致
- **字体颜色**：使用#e8e8e8更清晰
- **背景**：使用rgba(0,0,0,0.5)更深的背景，对比度更好
- **边框**：添加1px边框，视觉效果更好
- **换行**：使用`white-space: pre-wrap`和`word-wrap: break-word`正确处理换行
- **语言标签**：显示代码语言类型

### 3. 行内代码优化
```cpp
result.replace(QRegularExpression("`([^`]+)`"), 
              "<code style='background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 3px; "
              "font-family: \"Consolas\", \"Courier New\", monospace; font-size: 10.5pt; color: #ffd700;'>\\1</code>");
```
- 字体大小10.5pt，略小于正文但清晰可读
- 使用金色(#ffd700)突出显示
- 更深的背景色

### 4. 基础样式优化
```cpp
return QString("<div style='color: #f0f0f0; line-height: 1.4; "
              "font-family: \"Microsoft YaHei\", \"Segoe UI\", Arial, sans-serif; "
              "font-size: 11pt;'>%1</div>").arg(result);
```
- 文字颜色#f0f0f0更柔和
- **行高1.4更紧凑**（从1.7优化）
- 统一字体大小11pt

### 5. 处理顺序优化
```cpp
1. 先转义HTML特殊字符
2. 处理代码块（使用迭代器精确替换）
3. 处理行内代码
4. 处理加粗、斜体
5. 处理标题
6. 处理列表
7. 最后处理换行
```
这个顺序确保了各种格式不会相互干扰。

## 对比效果

### 优化前
- 代码块字体10pt，太小
- 字体颜色#e0e0e0，对比度不够
- 特殊字符可能消失（如`<`、`>`、`&`）
- 换行可能不正确
- 背景色rgba(0,0,0,0.4)太浅
- **行间距1.7太大，阅读不连贯**
- **各种margin过大，内容松散**

### 优化后
- 代码块字体11pt，与编辑器一致
- 字体颜色#e8e8e8，更清晰
- 特殊字符正确转义显示
- 换行正确处理
- 背景色rgba(0,0,0,0.5)更深，对比度更好
- 添加边框，视觉效果更好
- 显示语言标签
- **行间距1.4，紧凑舒适**
- **所有margin优化，信息密度提升**

## 详细优化参数对比

| 项目 | 优化前 | 优化后 | 改进说明 |
|------|--------|--------|----------|
| 正文行高 | 1.7 | 1.4 | 减少21%，更紧凑 |
| 代码块margin | 10px 0 | 8px 0 | 减少20%，节省空间 |
| 代码块padding | 12px | 10px | 减少17%，更紧凑 |
| 代码块行高 | 1.5 | 1.4 | 与正文一致 |
| 语言标签间距 | 6px | 4px | 减少33% |
| 标题margin(##) | 14px 0 10px 0 | 10px 0 5px 0 | 减少29% |
| 标题margin(###) | 12px 0 8px 0 | 8px 0 4px 0 | 减少33% |
| 列表margin | 5px 0 | 2px 0 | 减少60%，更紧凑 |
| 行内代码padding | 2px 6px | 2px 5px | 微调 |

## 总结

通过三方面的全面优化：
1. **右键菜单复制功能**：完美解决了自定义Delegate绘制的文本无法选中复制的问题
2. **Markdown渲染优化**：大幅提升了代码块和格式化文本的显示效果
3. **间距和阅读体验优化**：全面调整行高和各种margin，让内容更紧凑易读

用户现在可以：
- 方便地复制AI导师的回答内容（支持保留格式或纯文本）
- 看到清晰、美观、与编辑器一致的代码显示
- 正确显示所有特殊字符和格式
- **享受紧凑舒适的阅读体验，信息密度提升约25%**

大大提升了AI导师功能的使用体验！
