# 题库面板交互优化完成

## 修复时间
2024-12-05

## 修复的问题

### 问题1：筛选框支持滚轮滚动
**现象**：鼠标在筛选下拉框上滚动滚轮时，会改变下拉框的选项，而不是滚动页面

**原因**：QComboBox 默认响应滚轮事件来改变选项

**解决方案**：
使用事件过滤器拦截筛选器的滚轮事件：

```cpp
// 安装事件过滤器
m_difficultyFilter->installEventFilter(this);
m_tagFilter->installEventFilter(this);
m_statusFilter->installEventFilter(this);
m_sortCombo->installEventFilter(this);

// 在 eventFilter 中拦截
if (event->type() == QEvent::Wheel) {
    if (watched == m_difficultyFilter || watched == m_tagFilter || 
        watched == m_statusFilter || watched == m_sortCombo) {
        return true;  // 吞掉滚轮事件
    }
}
```

### 问题2：鼠标在表格中时不要滚动面板
**现象**：鼠标在题目表格上时，即使表格内容已经滚动到底，滚轮事件会传递给外层面板，导致面板滚动

**需求**：当鼠标在表格上时，无论表格能否滚动，都不要让滚轮事件传递给父容器

**解决方案**：
使用事件过滤器拦截表格的滚轮事件：

1. 在头文件中声明事件过滤器：
```cpp
protected:
    bool eventFilter(QObject *watched, QEvent *event) override;
```

2. 在 setupUI() 中安装事件过滤器：
```cpp
m_questionTable->installEventFilter(this);
m_questionTable->viewport()->installEventFilter(this);
```

3. 实现事件过滤器（智能处理表格滚动）：
```cpp
bool PracticeWidget::eventFilter(QObject *watched, QEvent *event)
{
    if (event->type() == QEvent::Wheel) {
        // 处理筛选器
        if (watched == m_difficultyFilter || watched == m_tagFilter || 
            watched == m_statusFilter || watched == m_sortCombo) {
            return true;  // 拦截筛选器的滚轮事件
        }
        
        // 处理表格
        if (watched == m_questionTable || watched == m_questionTable->viewport()) {
            QWheelEvent *wheelEvent = static_cast<QWheelEvent*>(event);
            QScrollBar *vScrollBar = m_questionTable->verticalScrollBar();
            
            if (vScrollBar) {
                int delta = wheelEvent->angleDelta().y();
                bool atTop = (vScrollBar->value() == vScrollBar->minimum());
                bool atBottom = (vScrollBar->value() == vScrollBar->maximum());
                
                // 只在边界时拦截，让表格自己可以滚动
                if ((delta > 0 && atTop) || (delta < 0 && atBottom)) {
                    return true;  // 在边界时拦截
                }
                return false;  // 不在边界时让表格处理
            }
            return true;  // 没有滚动条时拦截
        }
    }
    
    return QWidget::eventFilter(watched, event);
}
```

**关键点**：
- 表格可以正常滚动自己的内容
- 只有当表格滚动到顶部或底部时，才拦截滚轮事件
- 这样既保证了表格的可用性，又防止了意外滚动外层面板

### 问题3：点击题目后没有加载到编辑界面
**现象**：双击题目表格中的题目后，虽然跳转到编辑页面，但题目内容没有显示

**原因**：MainWindow 依赖 `m_questionBank` 来查找题目，但 `PracticeWidget` 从 `QuestionBankManager` 加载题目，两者可能不同步

**解决方案**：
修改 MainWindow 的信号处理逻辑，直接使用 PracticeWidget 发送的题目对象：

```cpp
connect(m_practiceWidget, &PracticeWidget::questionSelected, this, [this](const Question &question) {
    // 验证题目有效性
    if (question.id().isEmpty()) {
        return;
    }
    
    // 切换到刷题模式
    m_stackedWidget->setCurrentIndex(0);
    
    // 直接设置题目，不需要在 m_questionBank 中查找
    if (m_questionPanel) {
        m_questionPanel->setQuestion(question);
    }
    
    // 加载保存的代码
    loadSavedCode(question.id());
    
    // 尝试在 m_questionBank 中找到索引（用于导航）
    for (int i = 0; i < m_questionBank->count(); ++i) {
        if (m_questionBank->allQuestions()[i].id() == question.id()) {
            m_currentQuestionIndex = i;
            break;
        }
    }
    
    statusBar()->showMessage(QString("已选择题目: %1").arg(question.title()), 3000);
});
```

**关键改进**：
- 不再依赖 `m_questionBank` 来查找题目
- 直接使用 PracticeWidget 发送的完整题目对象
- 即使题目不在 `m_questionBank` 中，也能正常加载到编辑界面

### 问题4：题目表格选中时有圆框
**现象**：点击题目后，选中的单元格周围有圆角边框

**原因**：CSS 中 `QTableWidget::item` 有默认的 border 样式

**解决方案**：
```cpp
"QTableWidget::item {"
"    padding: 8px;"
"    border: none;"  // 移除边框
"}"
"QTableWidget::item:selected {"
"    background-color: #660000;"
"    border: none;"  // 移除选中时的边框
"}"
"QTableWidget::item:focus {"
"    outline: none;"
"    border: none;"  // 移除焦点时的边框
"}"
```

### 问题5：进度条是方的但边框是圆的
**现象**：进度条的填充部分（chunk）是方形的，但外边框是圆角的，视觉不协调

**原因**：`QProgressBar::chunk` 的 border-radius 和 margin 设置不当

**解决方案**：
```cpp
"QProgressBar {"
"    border: 1px solid #4a4a4a;"
"    border-radius: 22px;"  // 外边框圆角
"    background-color: #2d2d2d;"
"    text-align: center;"
"    color: #e8e8e8;"
"    font-size: 9pt;"
"    padding: 2px;"         // 减少内边距，为 chunk 留出空间
"}"
"QProgressBar::chunk {"
"    background-color: %1;"
"    border-radius: 19px;"  // chunk 圆角 = 外边框圆角 - border - padding
"    margin: 2px;"          // 增加边距，让 chunk 与边框保持距离
"}"
```

**计算公式**：
- chunk border-radius = 外边框 border-radius - border width - padding
- 22px - 1px - 2px = 19px
- margin 设置为 2px，确保 chunk 不会贴边

**关键点**：
- 减少 padding 从 6px 改为 2px
- 增加 margin 从 1px 改为 2px
- 调整 chunk 的 border-radius 为 19px
- 这样 chunk 的圆角能完美对齐外边框的圆角

## 修改的文件
1. `src/ui/PracticeWidget.h` - 添加事件过滤器声明
2. `src/ui/PracticeWidget.cpp` - 修复问题1、2、3、4，实现事件过滤器
3. `src/ui/PracticeStatsPanel.cpp` - 修复问题5

## 技术要点

### Qt 焦点策略 (FocusPolicy)
- **Qt::NoFocus**：不接受焦点，不捕获键盘和滚轮事件
- **Qt::TabFocus**：只能通过 Tab 键获取焦点
- **Qt::ClickFocus**：只能通过点击获取焦点
- **Qt::StrongFocus**：可以通过 Tab 键和点击获取焦点，但不捕获滚轮
- **Qt::WheelFocus**：可以通过滚轮获取焦点（默认）

### 事件过滤器 (Event Filter)
Qt 的事件过滤器机制允许对象拦截其他对象的事件：

1. **安装事件过滤器**：
   ```cpp
   object->installEventFilter(filter);
   ```

2. **实现 eventFilter() 方法**：
   ```cpp
   bool eventFilter(QObject *watched, QEvent *event) override {
       if (watched == targetObject && event->type() == QEvent::Wheel) {
           return true;  // 拦截事件，不传递
       }
       return QWidget::eventFilter(watched, event);  // 继续传递
   }
   ```

3. **返回值含义**：
   - `true`：事件已处理，不再传递给其他对象
   - `false`：事件未处理，继续传递给其他对象

4. **viewport() 的作用**：
   - QTableWidget 的滚轮事件实际发生在 viewport() 上
   - 需要同时过滤 QTableWidget 和 viewport() 的事件

### 进度条圆角对齐
要让进度条的填充部分与边框圆角对齐：
1. chunk 的 border-radius 应略小于外边框
2. 添加 margin 让 chunk 与边框保持距离
3. 计算公式：chunk_radius = border_radius - border_width - margin

## 编译结果
✅ 编译成功，无错误

## 测试建议
1. **筛选框滚轮测试**：
   - 鼠标移到筛选下拉框上
   - 滚动滚轮
   - 验证页面滚动而不是改变下拉框选项

2. **表格滚动测试**：
   - 鼠标移到题目表格上
   - 滚动滚轮
   - 验证表格内容滚动（如果有滚动条）
   - 继续滚动滚轮直到表格内容到底
   - 再次滚动滚轮
   - 验证外层面板**不会**滚动（事件被拦截）

3. **题目加载测试**：
   - 双击题目表格中的任意题目
   - 查看控制台日志
   - 验证题目内容正确显示在编辑界面

4. **表格选中测试**：
   - 点击题目表格中的任意单元格
   - 验证选中行背景变为红色
   - 验证没有圆角边框

5. **进度条圆角测试**：
   - 查看难度分布的进度条
   - 验证填充部分的圆角与外边框圆角对齐
   - 验证没有方形的填充部分

## 相关文档
- 圆角元素文字显示修复完成.md
- 题库面板滚动区域重构完成.md
- 题库面板数据加载修复完成.md
