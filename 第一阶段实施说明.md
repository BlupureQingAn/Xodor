# 第一阶段实施说明 - 基础树形结构

## 已完成的工作

### 1. 创建 QuestionBankTreeWidget

**文件**：
- `src/ui/QuestionBankTreeWidget.h`
- `src/ui/QuestionBankTreeWidget.cpp`

**功能**：
- ✅ 树形展示 `data/基础题库/` 目录结构
- ✅ 根节点：📁 基础题库
- ✅ 题库节点：📚 题库名 (X 道题目)
- ✅ 题目节点：📄 文件名.json
- ✅ 支持展开/折叠
- ✅ 点击选择题目/题库
- ✅ 双击展开/折叠
- ✅ 递归加载子目录
- ✅ 统计题目数量

**核心方法**：
```cpp
// 加载题库树
void loadBankTree();

// 展开指定题库
void expandBank(const QString &bankPath);

// 选中指定题目
void selectQuestion(const QString &questionPath);

// 刷新树
void refreshTree();
```

**信号**：
```cpp
// 题目被选中
void questionSelected(const QString &filePath, const Question &question);

// 题库被选中
void bankSelected(const QString &bankPath);
```

### 2. 创建新的 QuestionBankPanel

**文件**：
- `src/ui/QuestionBankPanel_new.h`
- `src/ui/QuestionBankPanel_new.cpp`

**改动**：
- ❌ 删除双模式设计（Questions / QuestionBanks）
- ❌ 删除 QListWidget
- ❌ 删除难度筛选
- ❌ 删除题库管理按钮
- ✅ 使用 QuestionBankTreeWidget
- ✅ 保留搜索框（待实现过滤）
- ✅ 简化信号：questionFileSelected, bankSelected

---

## 下一步操作

### 步骤1：备份旧文件

```bash
# 备份旧的 QuestionBankPanel
mv src/ui/QuestionBankPanel.h src/ui/QuestionBankPanel_old.h
mv src/ui/QuestionBankPanel.cpp src/ui/QuestionBankPanel_old.cpp

# 使用新文件
mv src/ui/QuestionBankPanel_new.h src/ui/QuestionBankPanel.h
mv src/ui/QuestionBankPanel_new.cpp src/ui/QuestionBankPanel.cpp
```

### 步骤2：更新 CMakeLists.txt

添加新文件到编译列表：
```cmake
set(PROJECT_SOURCES
    # ... 其他文件
    src/ui/QuestionBankTreeWidget.h
    src/ui/QuestionBankTreeWidget.cpp
    # ...
)
```

### 步骤3：更新 MainWindow

**需要修改的地方**：

1. **信号连接**：
```cpp
// 旧的连接
connect(m_questionBankPanel, &QuestionBankPanel::questionSelected,
        this, &MainWindow::onQuestionSelected);

// 新的连接
connect(m_questionBankPanel, &QuestionBankPanel::questionFileSelected,
        this, &MainWindow::onQuestionFileSelected);
```

2. **新增槽函数**：
```cpp
void MainWindow::onQuestionFileSelected(const QString &filePath, const Question &question)
{
    // 加载题目
    m_currentQuestion = question;
    m_currentQuestionFilePath = filePath;
    
    // 更新UI
    m_questionPanel->setQuestion(question);
    m_codeEditor->setCode(question.template_code());
    
    // 更新状态栏
    statusBar()->showMessage(QString("已加载题目：%1").arg(question.title()), 3000);
}
```

3. **删除旧的模式切换代码**：
```cpp
// 删除这些调用
m_questionBankPanel->setMode(PanelMode::Questions);
m_questionBankPanel->setMode(PanelMode::QuestionBanks);
m_questionBankPanel->setQuestions(...);
```

### 步骤4：编译测试

```bash
cmake --build build --config Release
```

**测试项目**：
- [ ] 程序启动正常
- [ ] 左侧显示题库树
- [ ] 根节点"基础题库"可见
- [ ] 题库节点显示题目数量
- [ ] 点击题库可展开
- [ ] 点击题目文件可加载
- [ ] 双击展开/折叠正常

---

## 已知问题和待实现功能

### 待实现

1. **搜索过滤**
   - 搜索框输入时过滤树节点
   - 高亮匹配的节点

2. **题目状态图标**
   - 显示题目完成状态（⚪ 未开始、🔵 进行中、✅ 已完成、⭐ 已掌握）
   - 实时更新状态

3. **右键菜单**
   - 新增题目
   - 删除题目/题库
   - 重命名

4. **性能优化**
   - 懒加载（大题库时）
   - 虚拟化（题目很多时）

### 已知限制

1. **图标**
   - 当前使用 emoji 图标
   - 可能需要替换为真实图标资源

2. **样式**
   - 树形控件的展开/折叠图标需要图标资源
   - 当前使用默认样式

---

## 文件结构对比

### 旧结构（QuestionBankPanel）

```
QuestionBankPanel
├─ 模式1：题目列表
│  ├─ QListWidget (显示题目)
│  ├─ 搜索框
│  └─ 难度筛选
└─ 模式2：题库列表
   ├─ QListWidget (显示题库)
   ├─ 搜索框
   └─ 管理按钮（加载、删除、重命名）
```

### 新结构（QuestionBankPanel + QuestionBankTreeWidget）

```
QuestionBankPanel
├─ 搜索框
└─ QuestionBankTreeWidget (树形展示)
   └─ 📁 基础题库
      ├─ 📚 CCF (9 道题目)
      │  ├─ 📄 201312-1.json
      │  └─ ...
      └─ 📚 算法基础 (15 道题目)
```

---

## 优势

1. **更直观**：文件夹树形结构更符合用户习惯
2. **更简洁**：删除了双模式设计，代码更清晰
3. **更灵活**：支持多层级目录结构
4. **更易扩展**：右键菜单、拖拽等功能更容易添加

---

## 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| MainWindow 适配工作量大 | 中 | 中 | 保留旧文件作为参考 |
| 信号连接遗漏 | 高 | 中 | 仔细检查所有连接 |
| 编译错误 | 中 | 低 | 逐步修改，频繁编译 |
| 功能缺失 | 中 | 中 | 对照旧功能逐一实现 |

---

## 下一步计划

完成第一阶段后，进入第二阶段：

**第二阶段：会话保存与恢复**
- 扩展 SessionManager 保存树状态
- 保存当前打开的题库和题目
- 启动时自动恢复

**预计时间**：2-3 小时

---

## 总结

第一阶段已完成核心的树形控件开发，接下来需要：

1. ✅ 替换旧的 QuestionBankPanel 文件
2. ⏳ 更新 CMakeLists.txt
3. ⏳ 修改 MainWindow 适配新接口
4. ⏳ 编译测试

**建议**：先完成上述步骤，确保基本功能正常后，再进入第二阶段。
