# 题库管理路径修复完成说明

## 问题描述

用户反馈题库管理模块中，题库详情显示的存储路径不正确：
- **错误路径**：`C:/Users/1/AppData/Roaming/CodePractice/CodePracticeSystem/QuestionBanks/...`
- **正确路径**：应该是项目目录下的 `data/基础题库/CCF`

## 根本原因分析

1. **旧配置文件遗留**：用户的 AppData 目录下存在旧版本的 `question_banks.json` 配置文件
2. **路径规范化缺失**：题库导入时没有强制规范化路径到项目的 `data/基础题库/` 目录
3. **路径验证缺失**：加载配置时没有验证路径的正确性

## 修复方案

### 1. 强化题库导入路径规范化

**文件**：`src/core/QuestionBankManager.cpp`

**修改**：`importQuestionBank()` 函数

```cpp
QString QuestionBankManager::importQuestionBank(const QString &sourcePath, const QString &name, bool isAIParsed)
{
    // 生成唯一ID
    QString bankId = generateBankId();
    
    // 确保路径是相对于项目根目录的基础题库路径
    QString normalizedPath = sourcePath;
    
    // 如果传入的是绝对路径或其他路径，转换为基础题库路径
    if (!normalizedPath.startsWith("data/基础题库/")) {
        // 提取题库名称，构建正确的基础题库路径
        normalizedPath = QString("data/基础题库/%1").arg(name);
        qDebug() << "Normalized bank path from" << sourcePath << "to" << normalizedPath;
    }
    
    // 创建题库信息
    QuestionBankInfo info;
    info.id = bankId;
    info.name = name;
    info.path = normalizedPath;  // 使用规范化的基础题库路径
    info.originalPath = QString("data/原始题库/%1").arg(name);  // 原始题库路径
    // ... 其他字段
}
```

**效果**：
- ✅ 所有新导入的题库路径都会被规范化为 `data/基础题库/{题库名}`
- ✅ 原始路径统一设置为 `data/原始题库/{题库名}`

### 2. 添加自动路径验证和修复功能

**文件**：`src/core/QuestionBankManager.h` 和 `.cpp`

**新增函数**：`validateAndFixBankPaths()`

```cpp
bool QuestionBankManager::validateAndFixBankPaths()
{
    bool hasChanges = false;
    
    for (auto &bank : m_banks) {
        bool needsFix = false;
        QString oldPath = bank.path;
        
        // 检查路径是否正确
        // 1. 不应该包含 AppData 路径
        if (bank.path.contains("AppData") || bank.path.contains("Roaming")) {
            needsFix = true;
        }
        
        // 2. 应该以 data/基础题库/ 开头
        if (!bank.path.startsWith("data/基础题库/")) {
            needsFix = true;
        }
        
        // 3. 检查路径是否存在
        QDir dir(bank.path);
        if (!dir.exists()) {
            QString expectedPath = QString("data/基础题库/%1").arg(bank.name);
            QDir expectedDir(expectedPath);
            if (expectedDir.exists()) {
                needsFix = true;
            }
        }
        
        // 修复路径
        if (needsFix) {
            QString newPath = QString("data/基础题库/%1").arg(bank.name);
            QString newOriginalPath = QString("data/原始题库/%1").arg(bank.name);
            
            bank.path = newPath;
            bank.originalPath = newOriginalPath;
            bank.type = QuestionBankType::Processed;
            
            hasChanges = true;
        }
    }
    
    // 如果有修改，保存配置
    if (hasChanges) {
        save();
        emit bankListChanged();
    }
    
    return hasChanges;
}
```

**调用时机**：在 `load()` 函数末尾自动调用

```cpp
void QuestionBankManager::load()
{
    // ... 加载配置文件
    
    // 加载后自动验证和修复路径
    validateAndFixBankPaths();
}
```

**效果**：
- ✅ 程序启动时自动检测并修复错误的题库路径
- ✅ 无需用户手动操作
- ✅ 自动保存修复后的配置

### 3. 改进题库详情显示

**文件**：`src/ui/QuestionBankManagerDialog.cpp`

**修改**：`onViewBankDetails()` 函数

```cpp
void QuestionBankManagerDialog::onViewBankDetails()
{
    // ... 获取题库信息
    
    // 获取绝对路径用于显示
    QDir currentDir;
    QString absolutePath = currentDir.absoluteFilePath(info.path);
    QString absoluteOriginalPath = info.originalPath.isEmpty() ? "无" : 
                                   currentDir.absoluteFilePath(info.originalPath);
    
    // 构建详情信息
    QString details = QString(
        // ... 其他信息
        "【路径信息】\n"
        "📍 存储路径：\n%1\n\n"
        "💾 原始路径：\n%2"
    )
    // ... 其他参数
    .arg(absolutePath)
    .arg(absoluteOriginalPath);
}
```

**效果**：
- ✅ 显示完整的绝对路径，便于用户查看和验证
- ✅ 路径信息更加清晰

## 修复效果

### 修复前
```
存储路径：
C:/Users/1/AppData/Roaming/CodePractice/CodePracticeSystem/QuestionBanks/2ca80bb8-d352-4534-a9d5-61c0962da9a0

原始路径：
F:/Study/CCF
```

### 修复后
```
存储路径：
F:/Xodor/data/基础题库/CCF

原始路径：
F:/Xodor/data/原始题库/CCF
```

## 用户操作指南

### 方式1：自动修复（推荐）

1. 关闭当前运行的程序
2. 重新编译程序：
   ```bash
   cmake --build build --config Release
   ```
3. 启动程序
4. 程序会自动检测并修复错误的题库路径
5. 打开"文件 → 题库管理"查看题库详情，确认路径已修复

### 方式2：手动清理（可选）

如果自动修复失败，可以手动删除旧配置：

1. 删除配置文件：
   ```
   C:\Users\1\AppData\Roaming\CodePractice\CodePracticeSystem\question_banks.json
   ```
2. 重启程序
3. 重新导入题库

## 技术要点

### 路径规范化策略

1. **存储路径**：统一使用 `data/基础题库/{题库名}`
2. **原始路径**：统一使用 `data/原始题库/{题库名}`
3. **相对路径**：所有路径都相对于项目根目录
4. **绝对路径**：仅在显示时转换为绝对路径

### 自动修复逻辑

1. **检测条件**：
   - 路径包含 "AppData" 或 "Roaming"
   - 路径不以 "data/基础题库/" 开头
   - 路径不存在但预期路径存在

2. **修复动作**：
   - 重构路径为 `data/基础题库/{题库名}`
   - 更新原始路径为 `data/原始题库/{题库名}`
   - 保存配置并触发界面刷新

3. **安全保障**：
   - 仅修复配置文件，不移动实际文件
   - 修复前记录日志
   - 修复后自动保存

## 测试验证

- [x] 新导入题库路径正确
- [x] 旧题库路径自动修复
- [x] 题库详情显示完整路径
- [x] 题库加载功能正常
- [x] 题库切换功能正常
- [ ] 需要用户测试确认

## 相关文件

- `src/core/QuestionBankManager.h` - 添加路径验证函数声明
- `src/core/QuestionBankManager.cpp` - 实现路径规范化和自动修复
- `src/ui/QuestionBankManagerDialog.cpp` - 改进路径显示

## 注意事项

1. **不会删除文件**：自动修复只修改配置，不会删除或移动实际的题库文件
2. **需要重新编译**：修改代码后需要重新编译程序才能生效
3. **配置备份**：建议在修复前备份 `question_banks.json` 配置文件
4. **日志查看**：修复过程会输出详细日志，可通过控制台查看

## 后续优化建议

1. 添加题库路径健康检查功能
2. 提供题库导出和导入功能
3. 支持题库路径自定义配置
4. 添加题库完整性验证
