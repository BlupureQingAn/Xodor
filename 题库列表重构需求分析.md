# 题库列表重构需求分析

## 需求概述

将左侧"题目列表"改造为"题库列表"，实现文件夹树形结构展示和管理。

---

## 详细需求

### 1. 展示根目录"基础题库"文件夹

**当前状态**：
- QuestionBankPanel 有两种模式：题目列表模式 / 题库列表模式
- 题库列表模式显示 `data/基础题库/` 下的所有题库文件夹

**需求**：
- 改为树形结构
- 根节点：`data/基础题库/`
- 子节点：各个题库文件夹（如 CCF、算法基础等）
- 可展开/折叠
- 显示题库下的题目文件

**示例结构**：
```
📁 基础题库
  ├─ 📚 CCF (9 道题目)
  │   ├─ 📄 201312-1.json
  │   ├─ 📄 201312-2.json
  │   └─ ...
  ├─ 📚 算法基础 (15 道题目)
  │   ├─ 📄 排序算法.json
  │   └─ ...
  └─ 📚 数据结构 (20 道题目)
```

---

### 2. 自动保存与加载逻辑适配

**需求**：
- 保存当前打开的题库文件夹路径
- 保存当前打开的题目文件路径
- 程序重启后自动恢复到上次的位置

**需要保存的信息**：
```json
{
  "currentBankPath": "data/基础题库/CCF",
  "currentQuestionFile": "data/基础题库/CCF/201312-1.json",
  "currentQuestionIndex": 0,
  "expandedNodes": ["data/基础题库", "data/基础题库/CCF"]
}
```

**涉及的文件**：
- `src/utils/SessionManager.h/cpp` - 会话管理
- `src/ui/MainWindow.cpp` - 启动时恢复

---

### 3. 右键菜单功能

#### 3.1 新增题目

**触发位置**：
- 右键题库文件夹
- 右键题目文件

**功能选项**：
1. **手动输入新增题目**
   - 打开题目编辑对话框
   - 填写题目信息：
     - 题目标题
     - 题目描述
     - 输入格式
     - 输出格式
     - 样例输入/输出
     - 难度
     - 标签
   - 保存为 JSON 文件

2. **文件导入**
   - 选择 JSON 文件
   - 选择 Markdown 文件
   - 批量导入多个文件

**UI设计**：
```
┌─────────────────────────────────────┐
│  新增题目                            │
├─────────────────────────────────────┤
│  ○ 手动输入                          │
│  ○ 文件导入                          │
│                                     │
│  [下一步]  [取消]                    │
└─────────────────────────────────────┘
```

**手动输入面板**：
```
┌─────────────────────────────────────┐
│  新增题目 - 手动输入                  │
├─────────────────────────────────────┤
│  题目标题: [________________]        │
│  难度: [简单 ▼]                      │
│  标签: [________________]            │
│                                     │
│  题目描述:                           │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  输入格式:                           │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  输出格式:                           │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  样例输入:                           │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  样例输出:                           │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  [保存]  [取消]                      │
└─────────────────────────────────────┘
```

#### 3.2 删除题目/题库

**功能**：
- 删除选中的题目文件
- 删除选中的题库文件夹（包含所有题目）
- 支持 Ctrl+Z 撤回

**撤回机制**：
- 删除时不直接删除文件
- 移动到回收站（临时目录）
- 记录删除操作到撤销栈
- Ctrl+Z 时从回收站恢复

**回收站结构**：
```
data/.trash/
  ├─ 2025-12-05_14-30-00_CCF/
  │   └─ 201312-1.json
  ├─ 2025-12-05_14-31-00_算法基础/
  │   └─ ...
```

**撤销栈**：
```cpp
struct DeleteOperation {
    QString type;  // "question" or "bank"
    QString originalPath;
    QString trashPath;
    QDateTime deleteTime;
};

QStack<DeleteOperation> m_undoStack;
```

---

## 技术实现方案

### 方案1：使用 QTreeWidget（推荐）

**优点**：
- Qt 原生控件，稳定可靠
- 支持树形结构
- 支持拖拽、右键菜单
- 易于实现

**缺点**：
- 样式定制相对复杂

**实现**：
```cpp
class QuestionBankTreeWidget : public QTreeWidget
{
    Q_OBJECT
public:
    explicit QuestionBankTreeWidget(QWidget *parent = nullptr);
    
    void loadBankTree();
    void expandBank(const QString &bankPath);
    
signals:
    void questionSelected(const QString &filePath);
    void bankSelected(const QString &bankPath);
    
private:
    void loadBankNode(QTreeWidgetItem *parentItem, const QString &path);
    void onItemClicked(QTreeWidgetItem *item, int column);
    void onItemDoubleClicked(QTreeWidgetItem *item, int column);
    void showContextMenu(const QPoint &pos);
    
    // 右键菜单操作
    void onAddQuestion();
    void onImportQuestions();
    void onDeleteItem();
    
    // 撤销操作
    void onUndo();
    
    QStack<DeleteOperation> m_undoStack;
};
```

### 方案2：使用 QTreeView + QFileSystemModel

**优点**：
- 自动监听文件系统变化
- 性能好

**缺点**：
- 定制复杂
- 需要自定义模型

---

## 实施步骤

### 第一阶段：基础树形结构

1. **创建 QuestionBankTreeWidget**
   - 继承 QTreeWidget
   - 实现基本的树形展示
   - 加载 `data/基础题库/` 结构

2. **替换 QuestionBankPanel**
   - 移除双模式设计
   - 使用 QuestionBankTreeWidget 替代 QListWidget
   - 保留搜索和筛选功能

3. **测试基本功能**
   - 展示题库树
   - 点击题库/题目
   - 展开/折叠

### 第二阶段：会话保存与恢复

1. **扩展 SessionManager**
   - 保存当前题库路径
   - 保存当前题目文件路径
   - 保存展开的节点

2. **实现自动恢复**
   - 启动时读取会话
   - 展开上次的节点
   - 选中上次的题目

3. **测试会话功能**
   - 关闭程序
   - 重新打开
   - 验证恢复正确

### 第三阶段：右键菜单 - 新增题目

1. **创建 AddQuestionDialog**
   - 选择输入方式（手动/导入）
   - 手动输入面板
   - 文件导入面板

2. **创建 QuestionEditorDialog**
   - 题目信息编辑表单
   - 验证输入
   - 保存为 JSON

3. **集成到右键菜单**
   - 右键题库 → 新增题目
   - 调用对话框
   - 刷新树

4. **测试新增功能**
   - 手动输入新增
   - 文件导入新增
   - 验证 JSON 格式

### 第四阶段：右键菜单 - 删除与撤销

1. **实现删除功能**
   - 移动到回收站
   - 记录到撤销栈
   - 刷新树

2. **实现撤销功能**
   - Ctrl+Z 快捷键
   - 从回收站恢复
   - 刷新树

3. **实现回收站清理**
   - 定期清理旧文件
   - 或手动清空

4. **测试删除和撤销**
   - 删除题目
   - 删除题库
   - Ctrl+Z 撤销
   - 验证文件恢复

---

## 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 树形结构性能问题 | 中 | 低 | 懒加载、虚拟化 |
| 会话恢复失败 | 中 | 中 | 容错处理、默认值 |
| 撤销栈内存占用 | 低 | 中 | 限制栈大小、定期清理 |
| 文件操作失败 | 高 | 低 | 异常处理、备份 |
| UI响应慢 | 中 | 低 | 异步加载 |

---

## 时间估算

| 阶段 | 预计时间 | 优先级 |
|------|---------|--------|
| 第一阶段：基础树形结构 | 3-4 小时 | 高 |
| 第二阶段：会话保存与恢复 | 2-3 小时 | 高 |
| 第三阶段：新增题目 | 4-5 小时 | 中 |
| 第四阶段：删除与撤销 | 3-4 小时 | 中 |
| **总计** | **12-16 小时** | - |

---

## 建议

1. **分阶段实施**：先完成基础树形结构，再逐步添加功能
2. **充分测试**：每个阶段完成后进行测试
3. **保留备份**：修改前备份现有代码
4. **用户反馈**：第一阶段完成后收集用户反馈

---

## 下一步

请确认：
1. 是否按照上述方案实施？
2. 是否需要调整某些功能？
3. 优先级是否需要调整？
4. 是否立即开始第一阶段的实施？
