# 题库管理功能诊断和修复说明

## 问题描述

用户反馈："题库管理对话框中显示的题目数量有问题，导入、切换、删除、查看信息都没有正确实现"

## 已添加的诊断功能

### 切换题库时的详细日志

现在切换题库时会输出详细的诊断信息：

```
=== 切换题库 ===
题库ID: bank_xxx
题库名称: CCF题库
题库路径: data/基础题库/CCF题库
题库题目数: 50
开始加载题库...
Loaded 50 questions from data/基础题库/CCF题库
加载完成，题目数量: 50
题库切换成功
```

### 错误检测

1. **路径不存在检测**：
   - 如果题库路径不存在，会显示警告
   - 提示用户检查题库是否已被删除

2. **空题库检测**：
   - 如果加载后题目数量为0，会显示警告
   - 显示题库路径供用户检查

## 可能的问题和解决方案

### 问题1：题库路径不正确

**症状**：
- 题库管理对话框显示题目数量，但切换后加载不出来
- 日志显示："题库路径不存在"

**原因**：
- 题库注册时保存的路径不正确
- 题库文件被移动或删除

**解决方法**：
1. 打开题库管理对话框
2. 选中题库，点击"📤 导出路径"
3. 检查路径是否存在
4. 如果路径不存在，删除该题库并重新导入

### 问题2：JSON文件格式错误

**症状**：
- 题库路径存在，但加载题目数量为0
- 日志显示："加载完成，题目数量: 0"

**原因**：
- JSON文件格式不正确
- JSON文件为空
- JSON文件不包含题目数据

**解决方法**：
1. 打开题库目录
2. 检查JSON文件内容
3. 确保JSON格式正确：
   ```json
   {
     "id": "question_001",
     "title": "题目标题",
     "description": "题目描述",
     ...
   }
   ```
   或数组格式：
   ```json
   [
     {"id": "q1", "title": "题目1", ...},
     {"id": "q2", "title": "题目2", ...}
   ]
   ```

### 问题3：题库未注册

**症状**：
- 题库文件存在于`data/基础题库/`
- 但题库管理对话框中看不到

**原因**：
- 题库没有注册到QuestionBankManager
- 配置文件损坏

**解决方法**：
1. 使用"➕ 导入新题库"重新导入
2. 或者删除配置文件：`C:/Users/用户名/AppData/Roaming/CodePractice/CodePracticeSystem/question_banks.json`
3. 重启程序，重新导入所有题库

### 问题4：题目数量统计不准确

**症状**：
- 题库管理对话框显示的题目数量与实际不符
- 刷新后仍然不正确

**原因**：
- 统计逻辑有问题
- 缓存的数据过期

**解决方法**：
1. 选中题库
2. 点击"🔄 刷新题库"
3. 查看更新后的题目数量
4. 如果还是不对，查看日志中的详细信息

## 测试步骤

### 测试1：导入题库

1. 打开题库管理（Ctrl+M）
2. 点击"➕ 导入新题库"
3. 选择题库文件夹
4. 输入题库名称
5. 等待导入完成
6. **检查**：题库列表中是否显示新题库
7. **检查**：题目数量是否正确

### 测试2：切换题库

1. 打开题库管理（Ctrl+M）
2. 选中一个题库
3. 点击"✓ 切换到此题库"
4. **查看日志**：
   ```
   === 切换题库 ===
   题库ID: xxx
   题库名称: xxx
   题库路径: xxx
   开始加载题库...
   加载完成，题目数量: xxx
   ```
5. **检查**：状态栏是否显示"✅ 已切换到题库：xxx（N 道题目）"
6. **检查**：题库面板是否显示题目列表

### 测试3：查看详情

1. 打开题库管理（Ctrl+M）
2. 选中一个题库
3. 点击"👁️ 查看详情"
4. **检查**：是否显示详细信息
5. **检查**：题目数量、完成度等信息是否正确

### 测试4：刷新题库

1. 打开题库管理（Ctrl+M）
2. 选中一个题库
3. 点击"🔄 刷新题库"
4. **检查**：题目数量是否更新
5. **检查**：是否显示变化量

### 测试5：删除题库

1. 打开题库管理（Ctrl+M）
2. 选中一个题库
3. 点击"🗑️ 删除题库"
4. 确认删除
5. **检查**：题库是否从列表中消失
6. **检查**：如果删除的是当前题库，题目列表是否清空

## 手动检查题库数据

### 1. 检查题库配置文件

**位置**：`C:/Users/用户名/AppData/Roaming/CodePractice/CodePracticeSystem/question_banks.json`

**内容示例**：
```json
{
  "banks": [
    {
      "id": "bank_20241205_123456",
      "name": "CCF题库",
      "path": "data/基础题库/CCF题库",
      "questionCount": 50,
      "importTime": "2024-12-05T12:34:56",
      "isAIParsed": true
    }
  ],
  "currentBankId": "bank_20241205_123456"
}
```

**检查项**：
- `path` 是否正确
- `questionCount` 是否准确
- 路径是否存在

### 2. 检查题库文件

**位置**：`data/基础题库/{题库名称}/`

**检查项**：
- 目录是否存在
- 是否有JSON文件
- JSON文件格式是否正确
- JSON文件是否包含题目数据

### 3. 手动统计题目数量

```powershell
# 统计JSON文件数量
Get-ChildItem "data/基础题库/CCF题库" -Recurse -Filter *.json | Measure-Object

# 查看JSON文件内容
Get-Content "data/基础题库/CCF题库/question_001.json" | ConvertFrom-Json
```

## 修改文件

### src/ui/MainWindow.cpp
- 添加详细的切换题库日志
- 添加路径存在性检查
- 添加空题库警告
- 保存当前题库路径

## 编译结果

```
✅ 编译成功
✅ 可执行文件: build\CodePracticeSystem.exe
✅ 诊断功能已添加
```

## 下一步

1. **运行程序**
2. **打开题库管理**（Ctrl+M）
3. **尝试切换题库**
4. **查看控制台日志**
5. **根据日志信息诊断问题**
6. **反馈具体的错误信息**

现在程序会输出详细的诊断日志，可以帮助精确定位问题！请运行程序并告诉我看到了什么日志信息。
