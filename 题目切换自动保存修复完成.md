# 题目切换自动保存修复完成

## 修复时间
2024-12-05

## 问题描述
切换题目时，当前题目的代码没有被保存，导致代码丢失。

## 问题根源
1. **缺少保存逻辑**：切换题目前没有保存当前代码
2. **缺少题目ID设置**：新题目的ID没有设置到 CodeEditor
3. **缺少 getter 方法**：CodeEditor 没有 `getQuestionId()` 方法来获取当前题目ID

## 解决方案

### 1. 添加 getQuestionId() 方法（CodeEditor.h）
```cpp
QString getQuestionId() const { return m_currentQuestionId; }
```

### 2. 修改题目切换逻辑（MainWindow.cpp）
```cpp
connect(m_practiceWidget, &PracticeWidget::questionSelected, this, [this](const Question &question) {
    // 1. 保存当前题目的代码（如果有的话）
    if (m_codeEditor && !m_codeEditor->getQuestionId().isEmpty()) {
        qDebug() << "[MainWindow] Saving current code for question:" << m_codeEditor->getQuestionId();
        m_codeEditor->autoSaver()->forceSave();
    }
    
    // 2. 切换到刷题模式
    m_stackedWidget->setCurrentIndex(0);
    
    // 3. 设置题目到面板
    if (m_questionPanel) {
        m_questionPanel->setQuestion(question);
    }
    
    // 4. 设置新题目ID到代码编辑器（这会触发AutoSaver加载保存的代码）
    if (m_codeEditor) {
        m_codeEditor->setQuestionId(question.id());
    }
    
    // 5. 加载保存的代码（如果AutoSaver没有加载，则手动加载）
    loadSavedCode(question.id());
    
    // 6. 更新题目索引
    // ...
});
```

## 修改的文件
1. `src/ui/CodeEditor.h` - 添加 `getQuestionId()` 方法
2. `src/ui/MainWindow.cpp` - 修改题目切换逻辑，添加保存和加载步骤

## 工作流程

### 切换题目时的完整流程：
1. **保存当前代码**：
   - 检查当前是否有题目（`getQuestionId()` 不为空）
   - 调用 `autoSaver()->forceSave()` 立即保存

2. **切换界面**：
   - 切换到刷题模式（index 0）

3. **设置新题目**：
   - 设置题目到 QuestionPanel 显示
   - 设置题目ID到 CodeEditor（触发 AutoSaver 的题目切换逻辑）

4. **加载代码**：
   - AutoSaver 会自动加载新题目的保存代码
   - `loadSavedCode()` 作为备用加载机制

5. **更新索引**：
   - 在 m_questionBank 中查找题目索引（用于上一题/下一题导航）

## AutoSaver 的作用

### 自动保存机制：
- **定时保存**：代码修改后自动触发保存定时器
- **强制保存**：`forceSave()` 立即保存，不等待定时器
- **题目切换**：`setQuestionId()` 会触发保存当前题目并加载新题目

### 保存位置：
- 代码保存在 `data/user_answers/{questionId}.json`
- 包含代码内容和元数据

## 相关功能

### 版本管理：
- AutoSaver 集成了 CodeVersionManager
- 测试通过时可以保存代码版本
- 支持版本历史查看和恢复

### 会话恢复：
- 程序启动时自动加载上次的题目
- 保持用户的工作状态

## 编译结果
✅ 编译成功，无错误

## 测试建议
1. **基本切换测试**：
   - 在题目A中编写代码
   - 切换到题目B
   - 再切换回题目A
   - 验证代码是否保存

2. **空题目测试**：
   - 启动程序（没有当前题目）
   - 选择一个题目
   - 验证不会崩溃

3. **快速切换测试**：
   - 快速连续切换多个题目
   - 验证每个题目的代码都正确保存和加载

4. **代码修改测试**：
   - 修改题目A的代码
   - 立即切换到题目B（不等待自动保存）
   - 切换回题目A
   - 验证修改是否保存

## 相关文档
- 题库面板交互优化完成.md
- AI判题功能修复.md
