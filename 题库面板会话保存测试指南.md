# 题库面板会话保存测试指南

## 问题描述
用户报告：
1. 左侧题库面板展开的文件夹状态没有保存
2. 从题库面板点击的题目在关闭后没有保存
3. 重新打开程序后，面板状态丢失

## 修复内容

### 修复 onQuestionFileSelected 方法

**问题**：从题库面板点击题目时，没有保存会话状态

**修复前**：
```cpp
void MainWindow::onQuestionFileSelected(const QString &filePath, const Question &question)
{
    // 只加载题目，不保存状态
    m_questionPanel->setQuestion(question);
    m_codeEditor->setCode(savedCode);
}
```

**修复后**：
```cpp
void MainWindow::onQuestionFileSelected(const QString &filePath, const Question &question)
{
    // 1. 保存当前题目的代码
    if (m_codeEditor && !m_codeEditor->getQuestionId().isEmpty()) {
        m_codeEditor->autoSaver()->forceSave();
    }
    
    // 2. 加载题目到面板
    m_questionPanel->setQuestion(question);
    
    // 3. 设置新题目ID到代码编辑器
    m_codeEditor->setQuestionId(question.id());
    
    // 4. 加载保存的代码
    QString savedCode = loadSavedCodeForQuestion(question.id());
    if (savedCode.isEmpty()) {
        savedCode = generateDefaultCode(question);
    }
    m_codeEditor->setCode(savedCode);
    
    // 5. 查找题目索引
    for (int i = 0; i < m_questionBank->count(); ++i) {
        if (m_questionBank->allQuestions()[i].id() == question.id()) {
            m_currentQuestionIndex = i;
            break;
        }
    }
    
    // 6. 保存会话状态
    QString currentBankId = QuestionBankManager::instance().getCurrentBankId();
    if (!currentBankId.isEmpty()) {
        QuestionBankInfo bankInfo = QuestionBankManager::instance().getBankInfo(currentBankId);
        QString currentBankPath = bankInfo.path;
        if (!currentBankPath.isEmpty()) {
            SessionManager::instance().saveSession(currentBankPath, m_currentQuestionIndex, question.id());
        }
    }
    
    // 7. 保存题库面板状态
    if (m_questionBankPanel) {
        QStringList expandedPaths = m_questionBankPanel->getExpandedPaths();
        QString selectedPath = m_questionBankPanel->getSelectedQuestionPath();
        SessionManager::instance().savePanelState(expandedPaths, selectedPath);
    }
}
```

## 测试步骤

### 测试 1：展开状态保存
1. 打开程序
2. 在左侧题库面板展开几个文件夹
3. 关闭程序
4. 重新打开程序
5. **验证**：展开的文件夹应该保持展开状态

**预期结果**：
- ✅ 展开的文件夹保持展开
- ✅ 折叠的文件夹保持折叠

### 测试 2：从题库面板选择题目
1. 打开程序
2. 在左侧题库面板点击一道题目
3. 编写一些代码
4. 关闭程序
5. 重新打开程序
6. **验证**：
   - 题目应该自动加载
   - 代码应该恢复
   - 题目在面板中应该被选中

**预期结果**：
- ✅ 题目自动加载
- ✅ 代码正确恢复
- ✅ 面板中题目被选中

### 测试 3：切换题目
1. 打开程序
2. 在题库面板点击题目A
3. 编写代码
4. 点击题目B
5. 编写代码
6. 关闭程序
7. 重新打开程序
8. **验证**：应该加载题目B（最后选择的）

**预期结果**：
- ✅ 加载题目B
- ✅ 题目B的代码恢复
- ✅ 题目A的代码也被保存

### 测试 4：展开多层文件夹
1. 打开程序
2. 展开多层嵌套的文件夹
3. 选择深层文件夹中的题目
4. 关闭程序
5. 重新打开程序
6. **验证**：
   - 所有层级的文件夹都展开
   - 题目被选中
   - 可以看到选中的题目

**预期结果**：
- ✅ 多层文件夹都展开
- ✅ 题目正确选中
- ✅ 滚动到选中的题目

## 调试日志

### 保存时的日志
```
[MainWindow] Question file selected: data/基础题库/CCF/树上搜索.json 32_7899962939002065332
[MainWindow] Saving current code for question: 32_7899962939002065331
[MainWindow] Setting question ID to editor: 32_7899962939002065332
[MainWindow] Found question in bank at index: 5
[MainWindow] Session saved - Bank: data/基础题库/CCF Question: 32_7899962939002065332
[MainWindow] Panel state saved - Expanded: 3 Selected: data/基础题库/CCF/树上搜索.json
```

### 加载时的日志
```
[MainWindow] Restored panel state - Expanded: 3 Selected: data/基础题库/CCF/树上搜索.json
[MainWindow] Found question by ID: 32_7899962939002065332 at index: 5
```

## 数据验证

### 检查 data/last_session.json
```json
{
    "questionBankPath": "data/基础题库/CCF",
    "currentQuestionIndex": 5,
    "currentQuestionId": "32_7899962939002065332",
    "expandedBankPaths": [
        "data/基础题库",
        "data/基础题库/CCF",
        "data/基础题库/CCF/算法"
    ],
    "selectedQuestionPath": "data/基础题库/CCF/算法/树上搜索.json",
    "lastSaved": "2025-12-05T23:30:00"
}
```

**验证点**：
- ✅ `expandedBankPaths` 不为空
- ✅ `selectedQuestionPath` 指向正确的文件
- ✅ `currentQuestionId` 正确
- ✅ `lastSaved` 是最近的时间

### 检查代码保存
```
data/user_answers/32_7899962939002065332.json
```

**验证点**：
- ✅ 文件存在
- ✅ 包含代码内容
- ✅ 包含题目ID

## 常见问题

### Q1: 展开状态没有保存
**可能原因**：
- `getExpandedPaths()` 返回空列表
- `savePanelState()` 没有被调用

**调试方法**：
```cpp
QStringList expandedPaths = m_questionBankPanel->getExpandedPaths();
qDebug() << "Expanded paths:" << expandedPaths;
```

### Q2: 题目没有保存
**可能原因**：
- `onQuestionFileSelected` 没有调用 `saveSession`
- 题目ID为空

**调试方法**：
```cpp
qDebug() << "Question ID:" << question.id();
qDebug() << "Current bank path:" << currentBankPath;
```

### Q3: 恢复时文件夹没有展开
**可能原因**：
- 路径不匹配
- `restoreExpandedPaths` 没有被调用

**调试方法**：
```cpp
qDebug() << "Restoring paths:" << expandedPaths;
qDebug() << "Item path:" << getNodePath(item);
```

## 相关代码

### 保存流程
```
用户点击题目
    ↓
onQuestionFileSelected()
    ↓
保存当前代码
    ↓
加载新题目
    ↓
设置题目ID
    ↓
saveSession(path, index, id)
    ↓
savePanelState(paths, selected)
    ↓
写入 data/last_session.json
```

### 加载流程
```
程序启动
    ↓
loadLastSession()
    ↓
loadSession(path, index, id)
    ↓
加载题库
    ↓
loadPanelState(paths, selected)
    ↓
restoreExpandedPaths(paths)
    ↓
selectQuestion(selected)
    ↓
loadCurrentQuestion()
```

## 修改的文件
- `src/ui/MainWindow.cpp` - 修复 `onQuestionFileSelected` 方法

## 总结

### 修复内容
- ✅ 添加会话保存到 `onQuestionFileSelected`
- ✅ 添加面板状态保存
- ✅ 添加代码自动保存
- ✅ 添加题目ID设置
- ✅ 添加调试日志

### 预期效果
- ✅ 从题库面板点击题目会保存状态
- ✅ 展开的文件夹会被记住
- ✅ 选中的题目会被记住
- ✅ 代码会自动保存和恢复

现在从题库面板点击题目应该可以正确保存和恢复了！
