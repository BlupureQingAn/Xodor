# 题库面板新增题目功能完成

## 实现内容
第三阶段：**右键支持新增题目（手动输入或文件导入）**

## 功能描述

### 1. 右键菜单
在左侧题库面板的树形控件中，支持以下右键操作：

#### 题库文件夹右键
- **➕ 新建题目**：在该题库下创建新题目
- **🗑️ 删除题库**：删除整个题库文件夹

#### 题目文件右键
- **✏️ 编辑题目**：编辑现有题目
- **🗑️ 删除题目**：删除该题目

### 2. 题目编辑器
创建了功能完整的题目编辑对话框 `QuestionEditorDialog`，支持：

#### 三种模式
1. **CreateMode**：创建新题目
2. **EditMode**：编辑现有题目
3. **ImportMode**：从文件导入题目

#### 编辑功能
- **基本信息**
  - 题目标题
  - 难度选择（简单/中等/困难）
  - 标签（支持多个，逗号分隔）

- **题目描述**
  - 支持 Markdown 格式
  - 多行文本编辑器

- **限制条件**
  - 时间限制（100-10000 ms）
  - 内存限制（64-1024 MB）

- **测试用例管理**
  - 动态添加/删除测试用例
  - 每个测试用例包含输入和期望输出
  - 可视化编辑界面

### 3. 导入方式
支持两种导入方式：

#### 手动输入
- 通过表单逐项填写题目信息
- 适合从零创建题目

#### 文件导入
- 支持 JSON 格式（完整题目数据）
- 支持 Markdown 格式（仅导入描述）
- 导入后可继续编辑

## 实现细节

### 1. QuestionEditorDialog 类

**文件**：`src/ui/QuestionEditorDialog.h`, `src/ui/QuestionEditorDialog.cpp`

#### 核心组件

```cpp
class QuestionEditorDialog : public QDialog
{
    Q_OBJECT
    
public:
    enum Mode {
        CreateMode,     // 创建新题目
        EditMode,       // 编辑现有题目
        ImportMode      // 从文件导入
    };
    
    explicit QuestionEditorDialog(Mode mode, QWidget *parent = nullptr);
    explicit QuestionEditorDialog(const Question &question, QWidget *parent = nullptr);
    
    Question getQuestion() const;
    void setQuestion(const Question &question);
    void importFromFile(const QString &filePath);
};
```

#### TestCaseItem 组件

```cpp
class TestCaseItem : public QWidget
{
    Q_OBJECT
public:
    explicit TestCaseItem(int index, QWidget *parent = nullptr);
    
    void setTestCase(const TestCase &testCase);
    TestCase getTestCase() const;
    
signals:
    void removeRequested();
};
```

每个测试用例是一个独立的 Widget，包含：
- 输入编辑器（QTextEdit）
- 输出编辑器（QTextEdit）
- 删除按钮

### 2. QuestionBankTreeWidget 扩展

**文件**：`src/ui/QuestionBankTreeWidget.h`, `src/ui/QuestionBankTreeWidget.cpp`

#### 新增方法

```cpp
private slots:
    void onCustomContextMenu(const QPoint &pos);
    void onAddQuestion();
    void onEditQuestion();
    void onDeleteQuestion();
    void onDeleteBank();
```

#### 右键菜单实现

```cpp
void QuestionBankTreeWidget::onCustomContextMenu(const QPoint &pos)
{
    QTreeWidgetItem *item = itemAt(pos);
    TreeNodeType type = getNodeType(item);
    
    QMenu menu(this);
    
    if (type == TreeNodeType::Bank) {
        // 题库文件夹菜单
        menu.addAction("➕ 新建题目");
        menu.addAction("🗑️ 删除题库");
    } else if (type == TreeNodeType::QuestionFile) {
        // 题目文件菜单
        menu.addAction("✏️ 编辑题目");
        menu.addAction("🗑️ 删除题目");
    }
    
    menu.exec(mapToGlobal(pos));
}
```

### 3. 题目ID生成

使用 MD5 哈希生成唯一ID：

```cpp
QString QuestionEditorDialog::generateQuestionId() const
{
    QString title = m_titleEdit->text();
    QString timestamp = QString::number(QDateTime::currentMSecsSinceEpoch());
    QString data = title + timestamp;
    
    QByteArray hash = QCryptographicHash::hash(data.toUtf8(), QCryptographicHash::Md5);
    return "custom_" + hash.toHex().left(16);
}
```

格式：`custom_` + 16位MD5哈希

### 4. 数据验证

在保存前验证输入：

```cpp
bool QuestionEditorDialog::validateInput()
{
    if (m_titleEdit->text().trimmed().isEmpty()) {
        QMessageBox::warning(this, "验证失败", "请输入题目标题");
        return false;
    }
    
    if (m_descriptionEdit->toPlainText().trimmed().isEmpty()) {
        QMessageBox::warning(this, "验证失败", "请输入题目描述");
        return false;
    }
    
    if (m_testCaseList->count() == 0) {
        QMessageBox::warning(this, "验证失败", "请至少添加一个测试用例");
        return false;
    }
    
    return true;
}
```

### 5. 文件保存

题目保存为 JSON 格式：

```cpp
QString fileName = newQuestion.title();
fileName.replace(QRegularExpression("[\\\\/:*?\"<>|]"), "_");
QString filePath = bankPath + "/" + fileName + ".json";

QFile file(filePath);
if (file.open(QIODevice::WriteOnly)) {
    QJsonDocument doc(newQuestion.toJson());
    file.write(doc.toJson(QJsonDocument::Indented));
    file.close();
}
```

## UI 设计

### 现代化深色主题
- 背景色：`#242424`
- 输入框背景：`#2d2d2d`
- 边框颜色：`#3a3a3a`
- 主题色：`#660000`（红色）
- 文字颜色：`#e8e8e8`

### 布局结构
```
┌─────────────────────────────────────┐
│  题目编辑器                          │
├─────────────────────────────────────┤
│  [滚动区域]                          │
│  ┌───────────────────────────────┐  │
│  │ 基本信息                       │  │
│  │  - 题目标题                    │  │
│  │  - 难度                        │  │
│  │  - 标签                        │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ 题目描述                       │  │
│  │  [多行文本编辑器]              │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ 限制条件                       │  │
│  │  - 时间限制                    │  │
│  │  - 内存限制                    │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ 测试用例                       │  │
│  │  ┌─────────────────────────┐  │  │
│  │  │ 测试用例 #1        [删除]│  │  │
│  │  │ 输入: [编辑器]            │  │  │
│  │  │ 输出: [编辑器]            │  │  │
│  │  └─────────────────────────┘  │  │
│  │  [➕ 添加测试用例]             │  │
│  └───────────────────────────────┘  │
├─────────────────────────────────────┤
│  [📁 从文件导入]  [取消]  [创建]    │
└─────────────────────────────────────┘
```

## 工作流程

### 创建新题目
1. 右键点击题库文件夹
2. 选择"➕ 新建题目"
3. 选择创建方式：
   - ✏️ 手动输入
   - 📁 文件导入
4. 填写题目信息
5. 添加测试用例
6. 点击"创建"按钮
7. 题目保存到题库文件夹
8. 自动刷新树形列表

### 编辑题目
1. 右键点击题目文件
2. 选择"✏️ 编辑题目"
3. 修改题目信息
4. 点击"保存"按钮
5. 更新题目文件
6. 自动刷新树形列表

### 从文件导入
1. 右键点击题库文件夹
2. 选择"➕ 新建题目"
3. 选择"📁 文件导入"
4. 选择 JSON 或 Markdown 文件
5. 自动填充题目信息
6. 可继续编辑
7. 点击"创建"保存

## 技术亮点

### 1. 动态测试用例管理
使用 QListWidget + 自定义 Widget 实现：
```cpp
TestCaseItem *item = new TestCaseItem(index, this);
QListWidgetItem *listItem = new QListWidgetItem(m_testCaseList);
listItem->setSizeHint(item->sizeHint());
m_testCaseList->setItemWidget(listItem, item);
```

### 2. 信号连接
每个测试用例的删除按钮连接到父对话框：
```cpp
connect(item, &TestCaseItem::removeRequested, this, [this, item]() {
    // 查找并删除对应的 ListWidgetItem
    for (int i = 0; i < m_testCaseList->count(); ++i) {
        if (m_testCaseList->itemWidget(m_testCaseList->item(i)) == item) {
            delete m_testCaseList->takeItem(i);
            updateTestCaseIndices();
            break;
        }
    }
});
```

### 3. 文件名安全处理
自动替换非法字符：
```cpp
QString fileName = newQuestion.title();
fileName.replace(QRegularExpression("[\\\\/:*?\"<>|]"), "_");
```

### 4. 滚动区域
使用 QScrollArea 支持大量内容：
```cpp
QScrollArea *scrollArea = new QScrollArea(this);
scrollArea->setWidgetResizable(true);
scrollArea->setWidget(contentWidget);
```

## 用户体验

### 之前
- 只能通过 AI 导入题库
- 无法手动创建题目
- 无法编辑现有题目

### 现在
- ✅ 右键快速创建题目
- ✅ 支持手动输入和文件导入
- ✅ 可视化编辑界面
- ✅ 动态管理测试用例
- ✅ 实时验证输入
- ✅ 自动刷新列表

## 待完成功能

### 第四阶段：删除与撤销
- [ ] 实现删除到回收站
- [ ] 实现 Ctrl+Z 撤销删除
- [ ] 操作历史记录
- [ ] 批量操作支持

当前删除功能已实现，但撤销功能将在第四阶段完成。

## 测试建议

1. **创建题目测试**
   - 手动输入创建题目
   - 验证所有字段都正确保存
   - 验证题目出现在树中

2. **导入题目测试**
   - 从 JSON 文件导入
   - 从 Markdown 文件导入
   - 验证数据正确解析

3. **编辑题目测试**
   - 编辑现有题目
   - 修改各个字段
   - 验证更新正确保存

4. **测试用例管理**
   - 添加多个测试用例
   - 删除测试用例
   - 验证索引自动更新

5. **验证测试**
   - 尝试保存空标题
   - 尝试保存无描述
   - 尝试保存无测试用例
   - 验证错误提示正确

6. **文件名测试**
   - 使用特殊字符作为标题
   - 验证文件名正确转义
   - 验证文件正确保存

## 相关文件

### 新增文件
- `src/ui/QuestionEditorDialog.h` - 题目编辑器头文件
- `src/ui/QuestionEditorDialog.cpp` - 题目编辑器实现

### 修改文件
- `src/ui/QuestionBankTreeWidget.h` - 添加右键菜单支持
- `src/ui/QuestionBankTreeWidget.cpp` - 实现右键菜单功能

## 状态
✅ **第三阶段完成** - 新增题目功能已实现

准备进入第四阶段：**删除与撤销**
